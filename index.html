<!DOCTYPE html>
<html lang="en">
  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="online, gamma, spectroscopy, spectrometry, scintillator, mca, open-source, physics, science, web, application, particle-physics, nuclear, radiation, serial, spectrum, radiation, multi-channel analyzer">
    <meta name="description" content="Gamma MCA is a free and complete progressive web app for gamma spectroscopy. You can import spectrum files and record new ones using the serial interface.">
    <meta name="author" content="NuclearPhoenix">
    <meta name="robots" content="index, follow">
  	<meta name="title" content="Gamma MCA - Gamma-ray spectroscopy">
  	<meta name="language" content="English">
    <!--
      CSP: Only allow loading resources from this website.
      Script-src: unsafe-inline for now. Bad practice, but better than not having any CSP at all.
      Style-src: unsafe-inline needed for Plotly.js styles.
      Img-src needs data: and blob: otherwise it cannot load some images.
      Connect-src is used for fetch (Custom isotope list URL) - * allow all.
    -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self';
                                                        script-src 'self' 'unsafe-inline';
                                                        style-src 'self' 'unsafe-inline';
                                                        img-src 'self' data: blob: https://hits.seeyoufarm.com/api/count/incr/badge.svg;
                                                        connect-src * ">

    <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
    <link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="/assets/favicon/favicon.ico">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="msapplication-config" content="/assets/favicon/browserconfig.xml">
    <meta name="theme-color" content="#f6bd16">

    <title>Gamma MCA - Gamma-ray spectroscopy</title>

    <link rel="stylesheet" href="/assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="/assets/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/main.css">

    <link rel="manifest" href="/site.webmanifest">

  </head>
  <body>

    <!--

      LOADING AND NOSCRIPT ALERT

    -->
    <div id="loading" class="vh-100 vw-100 fixed-top">
      <div id="text-window" class="fixed-top m-5 p-5 text-center bg-light border border-3 rounded-3 border-primary">

        <noscript>
          <p class="fs-3 bg-danger text-white text-center">
            This website only works with Javascript enabled! You need to enable it in your browser to be able to use this site!
            Instructions on how to do this can be found <a class="link-light" title="Enable-Javascript.com" href="https://enable-javascript.com/" target="_blank">here</a>.
          </p>
        </noscript>

        <p class="fs-1">Loading. Please wait...</p>
        <div class="spinner-border spinner-border-lg text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>

      </div>

      <div class="vh-100 vw-100 bg-dark bg-opacity-75"></div>
    </div>

    <!--

      MAIN PAGE CONTENT

    -->
    <div class="container-fluid flex-column d-flex vh-100 pb-1 text-dark lh-sm main" id="main"> <!-- pb-1 needed for vertical scroll bar -->

      <div class="row border border-1 border-secondary bg-light">

        <div class="col-lg pt-1">

          <h2 class="fs-4">File Import</h2>

          <p>
            <strong>Spectrum File:</strong>
          </p>

          <div class="input-group input-group-sm">
            <input class="form-control form-control-sm" type="file" id="data" accept=".csv, .TKA, .xml" onchange="getFileData(this);">
            <button class="btn btn-primary btn-sm" type="button" onclick="removeFile('data');" title="Remove File"> <i class="fas fa-trash"></i> Clear</button>
          </div>

          <hr>

          <p>
            <strong>Background File:</strong>
          </p>

          <div class="input-group input-group-sm">
            <input class="form-control form-control-sm" type="file" id="background" accept=".csv, .TKA, .xml" onchange="getFileData(this, true);">
            <button class="btn btn-primary btn-sm" type="button" onclick="removeFile('background');" title="Remove File"> <i class="fas fa-trash"></i> Clear</button>
          </div>

          <hr>

          <p><strong>File Type:</strong></p>

          <p>
            <input id="r1" class="form-check-input" type="radio" value="2" name="filetype" onchange="selectFileType(this);">
            <label class="form-check-label align-middle" for="r1">RAW Stream (e.g. OGD, Serial)</label>
          </p>

          <p>
            <input id="r2" class="form-check-input" type="radio" value="1" name="filetype" checked="checked" onchange="selectFileType(this);">
            <label class="form-check-label align-middle" for="r2">Histogram (e.g. CSV, RadiaCode, TKA, XML)</label>
          </p>

        </div>

        <div class="col-lg-auto g-0">
          <div class="vr h-100 opacity-50"></div>
        </div>

        <div class="col-lg pt-1">

          <h2 class="fs-4">Serial Connection</h2>

          <div class="alert alert-warning visually-hidden" role="alert" id="serial-error">
            Looks like the Web Serial API is not supported. Please switch to the latest Chromium-based browser (Chrome, Edge, Opera, ...) or enable it in your browser's settings to use serial connections.
          </div>

          <div id="serial-div" class="invisible visually-hidden">

            <p>
              <strong>Select Port:</strong>
            </p>

            <div class="input-group input-group-sm">

              <button class="btn btn-primary btn-sm" type="button" onclick="listSerial();" title="Refresh List"> <i class="fas fa-sync"></i> </button>
              <select class="form-select form-select-sm ser-settings" id="port-selector" aria-label=".form-select-sm example" title="Choose a serial device">
                <!-- NOTHING -->
              </select>
              <button class="btn btn-primary btn-sm" type="button" onclick="requestSerial();" title="Add new device"> <i class="fas fa-plus"></i> Add </button>

            </div>

            <hr>

            <div class="clearfix pe-3 align-middle">

              <button class="btn btn-primary btn-sm ser-settings" id="record-button" type="button" data-bs-toggle="modal" data-bs-target="#recordModal" title="Start recording"> <i class="fas fa-play"></i> Record </button>
              <button class="btn btn-primary btn-sm ser-settings visually-hidden" id="pause-button" type="button" onclick="disconnectPort();" title="Pause recording"> <i class="fas fa-pause"></i> Pause </button>
              <button class="btn btn-primary btn-sm ser-settings visually-hidden" id="resume-button" type="button" onclick="startRecord(true);" title="Resume recording"> <i class="fas fa-play"></i> Resume </button>
              <button class="btn btn-primary btn-sm" id="stop-button" type="button" onclick="disconnectPort(true);" title="Stop recording" disabled> <i class="fas fa-stop"></i> Stop </button>

              <div id="recording-spinner" class="spinner-grow spinner-grow-sm text-danger visually-hidden align-middle" role="status">
                <span class="visually-hidden">Recording...</span>
              </div>

              <div class="float-end align-middle">

                <div class="vstack align-middle">
                  <span class="align-middle fw-bold"><span id="record-time"></span><span id="total-record-time"></span></span>

                  <div class="progress mt-1" id="ser-time-progress-bar">
                    <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" id="ser-time-progress" title="Serial recording progress"></div>
                  </div>
                </div>

              </div>

            </div>

            <hr>

            <div class="clearfix pe-3">

              <button class="btn btn-primary btn-sm" id="export-button" type="button" data-bs-toggle="modal" data-bs-target="#exportModal" title="Export spectrum" disabled>
                <i class="fas fa-file-export"></i> Export
              </button>

              <div class="float-end align-middle">
                <div class="vstack align-middle text-end">

                  <span class="align-middle fw-bold" id="cps"></span>
                  <span class="align-middle"><span id="avg-cps"></span><span id="avg-cps-std"></span></span>

                </div>
              </div>

            </div>

            <p class="mt-1">
              <button class="btn btn-primary btn-sm ser-settings" type="button" data-bs-toggle="modal" data-bs-target="#serialConsoleModal" title="Serial Console" disabled>
                <i class="fa-solid fa-terminal"></i> Console
              </button>
            </p>

          </div>

        </div>

        <div class="col-lg-auto g-0">
          <div class="vr h-100 opacity-50"></div>
        </div>

        <div class="col-md pt-1">

          <h2 class="fs-4">Calibration</h2>

          <form>

            <div class="vstack gap-1">

              <div class="hstack gap-2">
                <div class="input-group input-group-sm">
                  <label class="input-group-text" for="adc-a">A:</label>
                  <input class="form-control form-control-sm" type="number" id="adc-a" min="0" value="" title="Input ADC Channel A" placeholder="Data Point A">
                  <input type="checkbox" class="btn-check" id="select-a" onclick="toggleCalClick('a', this.checked);">
                  <label class="btn btn-outline-primary" for="select-a" title="Select from plot"> <i class="fa-solid fa-arrow-pointer"></i> </label>
                </div>

                <span> <i class="fa-solid fa-angles-right"></i> </span>

                <div class="input-group input-group-sm">
                  <input class="form-control form-control-sm" type="number" id="cal-a" min="1" value="" title="Energy for channel A" placeholder="Target Energy A">
                  <label class="input-group-text" for="cal-a">keV</label>
                </div>
              </div>

              <div class="hstack gap-2">
                <div class="input-group input-group-sm">
                  <label class="input-group-text" for="adc-b">B:</label>
                  <input class="form-control form-control-sm" type="number" id="adc-b" min="0" value="" title="Input ADC Channel B" placeholder="Data Point B">
                  <input type="checkbox" class="btn-check" id="select-b" onclick="toggleCalClick('b', this.checked);">
                  <label class="btn btn-outline-primary" for="select-b" title="Select from plot"> <i class="fa-solid fa-arrow-pointer"></i> </label>
                </div>

                <span> <i class="fa-solid fa-angles-right"></i> </span>

                <div class="input-group input-group-sm">
                  <input class="form-control form-control-sm" type="number" id="cal-b" min="1" value="" title="Energy for channel B" placeholder="Target Energy B">
                  <label class="input-group-text" for="cal-b">keV</label>
                </div>
              </div>

              <div class="hstack gap-2">
                <div class="input-group input-group-sm">
                  <label class="input-group-text" for="adc-c">C:</label>
                  <input class="form-control form-control-sm" type="number" id="adc-c" min="0" value="" title="Input ADC Channel C" placeholder="Data Point C">
                  <input type="checkbox" class="btn-check" id="select-c" onclick="toggleCalClick('c', this.checked);">
                  <label class="btn btn-outline-primary" for="select-c" title="Select from plot"> <i class="fa-solid fa-arrow-pointer"></i> </label>
                </div>

                <span> <i class="fa-solid fa-angles-right"></i> </span>

                <div class="input-group input-group-sm">
                  <input class="form-control form-control-sm" type="number" id="cal-c" min="1" value="" title="Energy for channel C" placeholder="Target Energy C">
                  <label class="input-group-text" for="cal-c">keV</label>
                </div>
              </div>

            </div>

            <hr>

            <p class="mb-1">Linear (2-point) or quadratic (3-point) calibration is supported.</p>
            <p class="mb-1">E[keV] = c<sub>1</sub> x<sup>2</sup> + c<sub>2</sub> x + c<sub>3</sub> (x ... Channel Number)</p>
            <p>Coefficients will be computed automatically.</p>

            <hr>

            <p>
              <input type="checkbox" class="btn-check" id="apply-cal" onclick="toggleCal(this.checked);">
              <label class="btn btn-outline-primary btn-sm" title="Toggle plot calibration" id="calibration-label" for="apply-cal"> <i class="fa-solid fa-check"></i> Calibrate </label>

              <button class="btn btn-primary btn-sm" type="reset" onclick="resetCal();" title="Clear calibration"> <i class="fas fa-trash"></i> Delete</button>

              <label for="cal-input" class="btn btn-primary btn-sm" type="button" title="Import a calibration.json"> <i class="fas fa-file-import"></i> Import </label>
              <input id="cal-input" class="visually-hidden" type="file" accept=".json" name="name" onchange="importCal(this);">

              <button class="btn btn-primary btn-sm" type="button" onclick="downloadCal();" title="Export the calibration.json"> <i class="fas fa-file-export"></i> Export </button>
            </p>

          </form>

        </div>

        <div class="col-lg-auto g-0">
          <div class="vr h-100 opacity-50"></div>
        </div>

        <div class="col-md-1 pt-1">

          <h2 class="fs-4">Info</h2>

          <strong>Hover:</strong>
          <p><span id="hover-data">None</span></p>

          <strong>Click:</strong>
          <p><span id="click-data">None</span></p>

          <hr>

          <strong>Spectrum cts:</strong>
          <p><span id="total-spec-cts">0</span></p>

          <strong>Background cts:</strong>
          <p><span id="total-bg-cts">0</span></p>

        </div>

      </div>

      <div class="row bg-light flex-grow-1 plot-div border border-top-0 border-1 border-secondary bg-light"> <!-- flex-fill -->
        <div class="col">

          <!--
            PLOT DIV
          -->
          <div class="w-100 h-100" id="plot"></div>

        </div>
      </div>

      <div class="plot-tools row border border-top-0 border-1 border-secondary bg-light">

        <div class="col-md-auto d-md-flex">
          <button class="btn btn-primary ps-2 pe-2 pt-1 pb-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvas" aria-controls="offcanvas" title="Open Settings Menu" onclick="loadIsotopes();">
            <i class="fas fa-sliders-h"></i> Settings
          </button>
        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">
          <button class="btn btn-primary btn-sm" type="button" onclick="resetPlot();" title="Reset plot settings"> <i class="fas fa-redo"></i> Reset Plot </button>
        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <span class="input-group-text">X</span>
            <button class="btn btn-primary btn-sm" type="button" id="xAxis" onclick="changeAxis(this);" title="Toggle x-axis scale">Linear</button>
          </div>

        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <span class="input-group-text">Y</span>
            <button class="btn btn-primary btn-sm" type="button" id="yAxis" onclick="changeAxis(this);" title="Toggle y-axis scale">Linear</button>
          </div>

        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <label class="input-group-text" for="smaVal">SMA Length</label>
            <input class="form-control form-control-sm" type="number" id="smaVal" min="1" max="1000" value="" onkeypress="enterPress(event, 'sma');" oninput="changeSma(this);" title="Width of simple moving average">

            <input type="checkbox" class="btn-check" id="sma" onclick="toggleSma(this.checked);">
            <label class="btn btn-outline-primary" for="sma" title="Toggle simple moving average">Enable</label>
          </div>

        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <span class="input-group-text">Type</span>
            <button class="btn btn-primary btn-sm" type="button" id="plotType" onclick="changeType(this);" title="Switch plot type"><i class="fas fa-chart-line"></i> Line</button>
          </div>

        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <span class="input-group-text">Counts</span>
            <button class="btn btn-primary btn-sm ser-settings" type="button" id="plot-cps" onclick="toggleCps(this);" title="Switch total or counts per second"> Total </button>
          </div>

        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <div class="input-group input-group-sm">
            <span class="input-group-text">Peaks</span>
            <button class="btn btn-primary btn-sm" type="button" onclick="findPeaks(this);" title="Find energy peaks or isotopes (experimental)">None</button>
          </div>

        </div>

        <div class="col-md-auto g-0">
          <div class="vr h-100"></div>
        </div>

        <div class="col-md-auto pt-1 pb-1">

          <input type="checkbox" class="btn-check" id="iso-hover" onclick="toggleIsoHover();">
          <label class="btn btn-outline-primary btn-sm" title="Show closest isotope when hovering (experimental)" for="iso-hover"> <i class="fa-solid fa-magnifying-glass"></i> Isotopes </label>

        </div>

        <!-- Float End
        <div class="col-md pt-1 pb-1 d-md-flex justify-content-md-end">

        </div>
        -->

      </div>

    </div>

    <!--

      BOOTSTRAP MODELS FOR SELECTION SCREENS,

    -->

    <!-- Record Modal -->
    <div class="modal fade" id="recordModal" tabindex="-1" aria-labelledby="exportModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title h4">Record Spectrum</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            What do you want to record?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancel </button>
            <button type="button" class="btn btn-primary ser-settings" data-bs-dismiss="modal" onclick="startRecord(false, 'data');"> Spectrum </button>
            <button type="button" class="btn btn-primary ser-settings" data-bs-dismiss="modal" onclick="startRecord(false, 'background');"> Background </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModal" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title h4">Export File</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            What do you want to export?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Cancel </button>
            <button type="button" class="btn btn-primary" onclick="downloadData('spectrum', 'data');"> Spectrum </button>
            <button type="button" class="btn btn-primary" onclick="downloadData('background', 'background');"> Background </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal fade" id="serialConsoleModal" tabindex="-1" aria-labelledby="serialConsoleModal" aria-hidden="true">
      <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h3 class="modal-title h4">Serial Console</h3>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">

            <div class="input-group input-group-md">
              <label class="input-group-text" for="ser-command"> <i class="fa-solid fa-terminal"></i> </label>
              <input type="text" class="form-control" id="ser-command" onkeypress="enterPress(event, 'send-command');" spellcheck="false">
              <button type="button" class="btn btn-primary" id="send-command" onclick="sendSerial(document.getElementById('ser-command').value);"> <i class="fa-solid fa-share"></i> Send </button>
            </div>

            <hr>

            <p class="font-monospace" id="ser-output"></p>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"> Close </button>
          </div>
        </div>
      </div>
    </div>

    <!--

      BOOTSTRAP OFFCANVAS FOR SETTINGS, INFO AND ISOTOPE VIEWER

    -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvas" aria-labelledby="offcanvasLabel">
      <div class="offcanvas-header">
        <img class="logo" src="/assets/logo.svg" alt="Logo" title="Gamma MCA Logo">
        <h1 class="display-6 offcanvas-title" id="offcanvasLabel">Gamma MCA</h1>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>

      <div class="offcanvas-body" id="offbody">

        <nav class="nav nav-tabs" role="tablist">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#isotopes" type="button" role="tab" aria-controls="isotopes" aria-selected="true">Isotopes</button>
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false">Settings</button>
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#info" type="button" role="tab" aria-controls="info" aria-selected="false">Info</button>
        </nav>
        <div class="tab-content" id="tabcontent">

          <div class="tab-pane fade show active me-2" id="isotopes" role="tabpanel" aria-labelledby="isotopes">
            <br>

            <h4 class="fs-5">
              Common Gamma-Ray Energies <button type="button" class="btn btn-outline-primary btn-sm float-end" title="Reload Isotope List" onclick="reloadIsotopes();"><i class="fa-solid fa-arrow-rotate-right"></i></button>
            </h4>
            <br>

            <div class="text-center">
              <div class="alert alert-danger visually-hidden" role="alert" id="iso-load-error"></div>

              <div class="alert alert-primary visually-hidden" role="alert" id="iso-loading">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p><strong>Loading...</strong></p>
              </div>
            </div>

            <div class="table-responsive"> <!-- style="max-height:70vh;" -->
              <table class="table table-hover align-middle">
                <caption>List of gamma-ray energies of common isotopes.</caption>
                <thead class="table-light"> <!-- style="box-shadow: inset 1px 1px #000, 0 2px #000;" -->
                  <tr>
                    <th> <input class="form-check-input" id="check-all-isos" type="checkbox" value="" onclick="selectAll(this)" title="Toggle all isotopes"> </th>
                    <th>Isotope</th>
                    <th>Energy [keV]</th>
                  </tr>
                </thead>

                <tbody id="iso-table"></tbody>

              </table>
            </div>

          </div>

          <div class="tab-pane fade me-2" id="settings" role="tabpanel" aria-labelledby="settings">
            <br>

            <div class="alert alert-success alert-dismissible fade show" role="alert" id="ls-available">
              <i class="fa-solid fa-floppy-disk"></i> Settings will be saved automatically in this browser without the use of cookies.
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="alert alert-warning alert-dismissible fade show" role="alert" id="ls-unavailable">
              <i class="fa-regular fa-floppy-disk"></i> Settings will <strong>not</strong> be saved!
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>

            <div class="accordion accordion-flush">
              <div class="accordion-item">
                <h4 class="accordion-header" id="panel1-heading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel1-collaps" aria-expanded="true" aria-controls="panel1-collaps">
                    Plot
                  </button>
                </h4>
                <div id="panel1-collaps" class="accordion-collapse collapse" aria-labelledby="panel1-heading">
                  <div class="accordion-body">

                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" role="switch" id="edit-plot" onclick="changeSettings('editMode', this);">
                      <label class="form-check-label" for="edit-plot">Editable Plot Labels (Axes Labels and Headline)</label>
                    </div>

                    <br>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="iso-hover-prox">Iso Hover Proximity</label>
                      <input type="number" class="form-control" id="iso-hover-prox" min="1" onkeypress="enterPress(event, 'setting1');">
                      <button class="btn btn-primary" type="button" id="setting1" onclick="changeSettings('maxIsoDist', document.getElementById('iso-hover-prox'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Input in keV. Any positive integer is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-url">Isotope List</label>
                      <input type="url" class="form-control" id="custom-url" onkeypress="enterPress(event, 'setting2');" spellcheck="false">
                      <button class="btn btn-primary" type="button" id="setting2" onclick="changeSettings('customURL', document.getElementById('custom-url'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>File must be of valid JSON format. Use only trusted sources!</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="iso-hover-prox">Download Plot</label>
                      <select class="form-select form-select-sm" id="download-format" aria-label="Plot download file format" onChange="changeSettings('plotDownload', this);">
                        <option value="png" selected>.png</option>
                        <option value="svg">.svg</option>
                        <option value="jpeg">.jpeg</option>
                        <option value="webp">.webp</option>
                      </select>
                    </div>
                    <p><small>File format for downloading a static plot. SVG looks the best.</small></p>

                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h4 class="accordion-header" id="panel2-heading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel2-collapse" aria-expanded="false" aria-controls="panel2-collapse">
                    File Import
                  </button>
                </h4>
                <div id="panel2-collapse" class="accordion-collapse collapse" aria-labelledby="panel2-heading">
                  <div class="accordion-body">

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-delimiter">CSV File Delimiter</label>
                      <input type="text" class="form-control" id="custom-delimiter" onkeypress="enterPress(event, 'setting3');" spellcheck="false">
                      <button class="btn btn-primary" type="button" id="setting3" onclick="changeSettings('fileDelimiter', document.getElementById('custom-delimiter'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Any character is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-file-adc">RAW Stream Channel No</label>
                      <input type="number" class="form-control" id="custom-file-adc" min="1" onkeypress="enterPress(event, 'setting4');">
                      <button class="btn btn-primary" type="button" id="setting4" onclick="changeSettings('fileChannels', document.getElementById('custom-file-adc'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Number of (ADC) channels of the original device. Any positive integer is valid.</small></p>

                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h4 class="accordion-header" id="panel3-heading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel3-collapse" aria-expanded="false" aria-controls="panel3-collapse">
                    Serial Connection
                  </button>
                </h4>
                <div id="panel3-collapse" class="accordion-collapse collapse" aria-labelledby="panel3-heading">
                  <div class="accordion-body">

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-baud">Baud Rate</label>
                      <input type="number" class="form-control serial-controls" id="custom-baud" min="1" onkeypress="enterPress(event, 'setting5');">
                      <button class="btn btn-primary serial-controls" type="button" id="setting5" onclick="changeSettings('baudRate', document.getElementById('custom-baud'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Input in bits per second. Any positive integer is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="eol-char">EOL character</label>
                      <input type="text" class="form-control serial-controls" id="eol-char" onkeypress="enterPress(event, 'setting5-1');" spellcheck="false">
                      <button class="btn btn-primary serial-controls" type="button" id="setting5-1" onclick="changeSettings('eolChar', document.getElementById('eol-char'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Character transmitted at the end of every single data point. Any character is valid.</small></p>

                    <div class="form-check form-switch">
                      <input class="form-check-input serial-controls" type="checkbox" role="switch" id="toggle-time-limit" onclick="changeSettings('timeLimitBool', this);">
                      <label class="form-check-label" for="toggle-time-limit">Enable Time Limit</label>
                    </div>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="ser-limit">Recording Time Limit</label>
                      <input type="number" class="form-control serial-controls" id="ser-limit"  min="1" onkeypress="enterPress(event, 'ser-limit-btn');" disabled>
                      <button class="btn btn-primary serial-controls" id="ser-limit-btn" type="button" onclick="changeSettings('timeLimit', document.getElementById('ser-limit'));" title="Apply" disabled> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Input in seconds. Any positive integer is valid. Serial recording will stop automatically when time runs out.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-ser-refresh">Plot Refresh Time</label>
                      <input type="number" class="form-control serial-controls" id="custom-ser-refresh" min="1" onkeypress="enterPress(event, 'setting6');">
                      <button class="btn btn-primary serial-controls" type="button" id="setting6" onclick="changeSettings('plotRefreshRate', document.getElementById('custom-ser-refresh'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Input in seconds. Any positive float is valid, use integers for best performance.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-ser-buffer">Max Serial Buffer</label>
                      <input type="number" class="form-control serial-controls" id="custom-ser-buffer" min="1" onkeypress="enterPress(event, 'setting7');">
                      <button class="btn btn-primary serial-controls" type="button" id="setting7" onclick="changeSettings('serBufferSize', document.getElementById('custom-ser-buffer'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Max number of serial input events buffered between plot refreshes. Any positive integer is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="custom-ser-adc">Serial Channel No</label>
                      <input type="number" class="form-control serial-controls" id="custom-ser-adc" min="1" onkeypress="enterPress(event, 'setting8');">
                      <button class="btn btn-primary serial-controls" type="button" id="setting8" onclick="changeSettings('serChannels', document.getElementById('custom-ser-adc'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Number of (ADC) channels of the serial device. Any positive integer is valid.</small></p>

                  </div>
                </div>
              </div>
              <div class="accordion-item">
                <h4 class="accordion-header" id="panel4-heading">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panel4-collapse" aria-expanded="false" aria-controls="panel4-collapse">
                    Energy Peak Detection
                  </button>
                </h4>
                <div id="panel4-collapse" class="accordion-collapse collapse" aria-labelledby="panel4-heading">
                  <div class="accordion-body">

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="peak-thres">Threshold</label>
                      <input type="number" class="form-control" id="peak-thres" min="0" step="0.001" onkeypress="enterPress(event, 'setting9');">
                      <button class="btn btn-primary" type="button" id="setting9" onclick="changeSettings('peakThres', document.getElementById('peak-thres'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Sensitivity of the vertical step size in relation to the highest value. Any positive float is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="peak-lag">Smooth</label>
                      <input type="number" class="form-control" id="peak-lag" min="1" onkeypress="enterPress(event, 'setting10');">
                      <button class="btn btn-primary" type="button" id="setting10" onclick="changeSettings('peakLag', document.getElementById('peak-lag'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Width of the overall moving average applied to the plot data that is used as a general reference. Any positive integer is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="peak-width">Width</label>
                      <input type="number" class="form-control" id="peak-width" min="1" onkeypress="enterPress(event, 'setting11');">
                      <button class="btn btn-primary" type="button" id="setting11" onclick="changeSettings('peakWidth', document.getElementById('peak-width'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Maximum distance two peak lines can be apart to count as one single peak. Any positive integer is valid.</small></p>

                    <div class="input-group input-group-sm">
                      <label class="input-group-text" for="seek-width">Isotope Seek</label>
                      <input type="number" class="form-control" id="seek-width" min="1" onkeypress="enterPress(event, 'setting12');">
                      <button class="btn btn-primary" type="button" id="setting12" onclick="changeSettings('seekWidth', document.getElementById('seek-width'));" title="Apply"> <i class="fas fa-check"></i> </button>
                    </div>
                    <p><small>Maximum distance to search for isotopes around the peak energy (multiple of the peak width). Any positive float is valid.</small></p>

                  </div>
                </div>
              </div>
            </div>

          </div>

          <div class="tab-pane fade me-2" id="info" role="tabpanel" aria-labelledby="info">
            <br>
            <p>Gamma MCA is a complete progressive web app for gamma spectroscopy. It is completely free and open-source with online and offline functionality. You can import spectrum files and record new ones using the serial interface.</p>

            <p>For a list of example spectra to help you get started head to the <a title="GammaDB" href="https://gammadb.nuclearphoenix.xyz" target="_blank">Gamma Spectrum Database</a>.</p>

            <p>Made free and open-source by <a title="NuclearPhoenix.xyz" href="https://nuclearphoenix.xyz" target="_blank">NuclearPhoenix</a> using Bootstrap, Plotly & Font Awesome. Licensed under the <a title="GitHub/License" href="https://github.com/Open-Gamma-Project/Gamma-MCA/blob/main/LICENSE" target="_blank">GNU General Public License v3.0</a>.</p>

            <p>This site is part of the <a title="Open Gamma Project" href="https://github.com/Open-Gamma-Project" target="_blank">Open Gamma Project</a> to provide modern and open-source resources for accessible gamma-spectroscopy.</p>

            <p>Get the source code on <a title="GitHub/Gamma-MCA" href="https://github.com/Open-Gamma-Project/Gamma-MCA" target="_blank"><i class="fab fa-github"></i> GitHub</a>.</p>
            <p>Report issues and bugs on <a title="GitHub/Issues" href="https://github.com/Open-Gamma-Project/Gamma-MCA/issues" target="_blank"><i class="fas fa-bug"></i> GitHub/Issues</a>.</p>
            <p>Questions? Discussions, Q&As and more can be found on <a title="GitHub/Discussions" href="https://github.com/Open-Gamma-Project/Gamma-MCA/discussions" target="_blank"><i class="fas fa-comments"></i> GitHub/Discussions</a>.</p>

            <hr>

            <p><span id="version-tag">Version </span> <a class="float-end" href="https://hits.seeyoufarm.com"><img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fspectrum.nuclearphoenix.xyz&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=true"/></a> </p>

            <div class="visually-hidden" id="manual-install">
              <hr>

              <button type="button" class="btn btn-primary btn-sm" title="Install Gamma MCA" onclick="installPWA();"><i class="fa-solid fa-download"></i> Install MCA</button>

              <p><small>Install Gamma MCA (PWA) on this device. It will behave like any other native app and will work outside this browser.</small></p>
            </div>

            <hr>

            <button type="button" class="btn btn-danger btn-sm" title="Reset Gamma MCA" onclick="resetMCA();"><i class="fa-solid fa-arrow-rotate-right"></i> Reset MCA</button>

            <p><small>Clears all settings, browser storage and reloads the page.</small></p>

          </div>

        </div>

      </div>
    </div>

    <!--

      BOOTSTRAP TOASTS FOR NOTIFICATIONS

    -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
      <div id="welcomeMsg" class="toast text-white bg-primary" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
        <div class="toast-header">
          <i class="fas fa-radiation me-2"></i>
          <strong class="me-auto">Welcome!</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <p>Thanks for using Gamma MCA, please report any bugs or issues on <a title="GitHub/Issues" class="text-white" href="https://github.com/Open-Gamma-Project/Gamma-MCA/issues" target="_blank"><small><i class="fa-solid fa-link"></i></small> GitHub/Issues</a>. Thank you.</p>
          <p>By using the website and source code, you agree to the <a  title="GitHub/License" class="text-white" href="https://github.com/Open-Gamma-Project/Gamma-MCA/blob/main/LICENSE" target="_blank"><small><i class="fa-solid fa-link"></i></small> license</a>.</p>
        </div>
      </div>

      <div id="pwa-installer" class="toast text-white bg-primary" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
        <div class="toast-header">
          <i class="fa-solid fa-download me-2"></i>
          <strong class="me-auto">Install App?</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          <p>Gamma MCA is a progressive web app! You can install it to use Gamma MCA standalone and offline like any native program.</p>
          <p>Do you want to install?</p>
          <div class="mt-2 pt-2 border-top">
            <button type="button" class="btn btn-light btn-sm" title="Install Gamma MCA" onclick="installPWA();">Install</button>
            <button type="button" class="btn btn-primary btn-sm" title="Dismiss" data-bs-dismiss="toast">No</button>
          </div>
        </div>
      </div>

      <div id="update-installed" class="toast bg-info text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
        <div class="toast-header">
          <i class="fa-solid fa-cloud-arrow-down me-2"></i>
          <strong class="me-auto">Installed Update</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          An update has been found and installed. You must reload Gamma MCA for the changes to take effect.
          <em>You can also continue with this page without reloading for now.</em>
        </div>
      </div>

      <div id="screen-size-warning" class="toast bg-warning" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="10000">
        <div class="toast-header">
          <i class="fas fa-info-circle me-2"></i>
          <strong class="me-auto">Window Size Warning</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Your window/screen size is smaller than recommended - therefore your experience may vary. For optimal usage increase the window size to a minimum of 1250 x 750 px.
        </div>
      </div>

      <div id="file-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">File Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Something went wrong, please reload and try again or report this issue.
        </div>
      </div>

      <div id="data-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">File Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Background and spectrum have a different number of channels. They must be same for this to work.
        </div>
      </div>

      <div id="sma-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">SMA Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          SMA input is invalid. Input must be an <em>integer</em>!
        </div>
      </div>

      <div id="cal-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Calibration Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Cannot calibrate. Need at least two calibration points with valid numbers!
        </div>
      </div>

      <div id="cal-import-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Calibration Import Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Something went wrong when importing the calibration. Please reload and try again or report this issue.
        </div>
      </div>

      <div id="serial-connect" class="toast bg-info text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
          <i class="fas fa-info-circle me-2"></i>
          <strong class="me-auto">Serial Connect</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Detected a new serial device.
        </div>
      </div>

      <div id="auto-stop" class="toast bg-info text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="8000">
        <div class="toast-header">
          <i class="fas fa-info-circle me-2"></i>
          <strong class="me-auto">Recording Stopped</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Your set time-limit has run out. The recording has been automatically stopped. Changing this limit can be done in the settings.
        </div>
      </div>

      <div id="serial-disconnect" class="toast bg-info text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
        <div class="toast-header">
          <i class="fas fa-info-circle me-2"></i>
          <strong class="me-auto">Serial Disconnect</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          A serial device was removed.
        </div>
      </div>

      <div id="misc-ser-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="8000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Serial Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Something went terribly wrong when trying to read from the serial port! Did you disconnect the device? Please try again.
        </div>
      </div>

      <div id="serial-connect-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="8000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Serial Connection Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Could not connect to the serial device. Maybe the port is already in use?
        </div>
      </div>

      <div id="setting-success" class="toast bg-success text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-check-circle me-2"></i>
          <strong class="me-auto">Changed Setting</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          A settings value has been changed successfully.
        </div>
      </div>

      <div id="setting-type" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Wrong Datatype</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          A settings value cannot be changed because the input value datatype is not correct.
        </div>
      </div>

      <div id="setting-error" class="toast bg-danger text-white" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="6000">
        <div class="toast-header">
          <i class="fas fa-exclamation-triangle me-2"></i>
          <strong class="me-auto">Settings Error</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          Something went wrong when trying to change a settings value, please reload and try again or report this issue.
        </div>
      </div>

    </div>

    <script src="/assets/js/external/bootstrap.min.js"></script>
    <script src="/assets/js/external/plotly-basic.min.js"></script>
    <!--
    <script src="/assets/js/raw-data.js"></script>
    <script src="/assets/js/plot.js"></script>
    <script src="/assets/js/serial.js"></script>
    -->
    <script src="/assets/js/main.js"></script>
  </body>
</html>
