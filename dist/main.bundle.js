(()=>{"use strict";var e={544:(e,t)=>{function n(e){return JSON.parse(localStorage.getItem(e))}function o(){const e=n("theme");return"auto"!==e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function a(e="dark"){const t="dark"===e?"light":"dark",n=document.getElementsByClassName("border-mode");for(const o of n)o.classList.replace(`border-${e}`,`border-${t}`);const o=document.getElementsByClassName("border-theme");for(const n of o)n.classList.replace(`border-${e}`,`border-${t}`),n.classList.replace(`bg-${e}`,`bg-${t}`)}function i(e){"auto"===e&&window.matchMedia("(prefers-color-scheme: dark)").matches?(document.documentElement.setAttribute("data-bs-theme","dark"),a("dark")):(document.documentElement.setAttribute("data-bs-theme",e),a(e))}Object.defineProperty(t,"__esModule",{value:!0}),t.applyTheming=t.autoThemeChange=void 0,t.autoThemeChange=function(){const e=n("theme");if("light"!==e&&"dark"!==e){const e=o();return i(e),e}return e},t.applyTheming=function(){const e=o();return i(e),e}},496:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.launchSysNotification=t.ToastNotification=void 0;const n={updateInstalled:{type:"info",icon:"fa-solid fa-cloud-arrow-down fa-beat animation-slow",header:"Installed Update",body:"An update has been found and installed. You must reload Gamma MCA for the changes to take effect. <br><br><em>You can also continue on this page without reloading for now.</em>"},fileError:{type:"danger",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"File Error",body:"Something went wrong, please reload and try again or report this issue."},settingError:{type:"danger",delay:4e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Settings Error",body:"Something went wrong when trying to change a settings value, please reload and try again or report this issue."},settingType:{type:"danger",delay:4e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Wrong Datatype",body:"A settings value cannot be changed because the input value datatype is not correct."},settingSuccess:{type:"success",delay:2e3,icon:"fas fa-check-circle fa-beat animation-slow",header:"Changed Setting",body:"A settings value has been changed successfully."},serialConnectError:{type:"danger",delay:8e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Serial Connection Error",body:"Could not connect to the serial device. Maybe the port is already in use?"},miscSerialError:{type:"danger",delay:8e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Serial Error",body:"Something went terribly wrong when trying to read from the serial port! Did you disconnect the device? Please try again."},serialDisconnect:{type:"info",delay:5e3,icon:"fas fa-info-circle fa-beat animation-slow",header:"Serial Disconnect",body:"A serial device was removed."},autoStop:{type:"info",icon:"fas fa-info-circle fa-beat animation-slow",header:"Recording Stopped",body:"Your set time-limit has run out. The recording has been automatically stopped. Changing this limit can be done in the settings."},dataError:{type:"danger",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"File Error",body:"Background and spectrum have a different number of channels. They must be same for this to work."},fileEmptyError:{type:"warning",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"No Data",body:"You are trying to export a file, but there is not data to export. Please try again when there is data to export."},smaError:{type:"danger",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"SMA Error",body:"SMA input is invalid. Input must be an <em>integer</em>!"},calibrationApplyError:{type:"danger",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Calibration Error",body:"Cannot calibrate. Need at least two calibration points with valid numbers!"},calibrationImportError:{type:"danger",delay:6e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Calibration Import Error",body:"Something went wrong when importing the calibration. Please reload and try again or report this issue."},serialConnect:{type:"info",delay:5e3,icon:"fas fa-info-circle fa-beat animation-slow",header:"Serial Connect",body:"Detected a new serial device."},welcomeMessage:{type:"primary",icon:"fas fa-radiation fa-beat animation-slow",header:"Welcome!",body:'<p>Thank you for using Gamma MCA, please report any bugs or issues on <a title="GitHub/Issues" class="link-light link-underline-opacity-50 link-underline-opacity-100-hover" href="https://github.com/OpenGammaProject/Gamma-MCA/issues" target="_blank"><small><i class="fa-solid fa-link"></i></small> GitHub/Issues</a>.</p><p>If you\'re new to this, you can have a look at the trailer on <a title="Youtube Trailer" class="link-light link-underline-opacity-50 link-underline-opacity-100-hover" href="https://www.youtube.com/watch?v=dkMhoUwDla0" target="_blank"><small><i class="fa-brands fa-youtube"></i></small> Youtube</a>.</p>'},saveMultipleAtOnce:{type:"warning",delay:8e3,icon:"fas fa-exclamation-triangle fa-shake",header:"File Save Error",body:"<p>You tried to save (overwrite) multiple files at once. This is not supported due to the risk of data loss.</p><p>If you want to combine and save data from different files, please use the <code>Save As</code> function.</p>"},saveFile:{type:"success",delay:3e3,icon:"fas fa-check-circle fa-beat animation-slow",header:"Saved File",body:"Successfully saved data to the file system."},reportError:{type:"warning",delay:5e3,icon:"fas fa-exclamation-triangle fa-shake",header:"Missing Data",body:"Cannot generate a report since there is no data. Please try again when there is data to analyze."}};t.ToastNotification=class{toastElement;toast;toastContainer;constructor(e){if(this.toastContainer=document.getElementById("toast-container"),!this.toastContainer)return void console.error("Toast container does not exist:",this.toastContainer);const t=n[e];if(!t)return void console.error("Not a valid notification:",e,t);const o=document.createElement("div");o.className=`toast text-bg-${t.type}`,o.setAttribute("role","alert"),o.setAttribute("aria-live","assertive"),o.setAttribute("aria-atomic","true"),t.delay?(o.setAttribute("data-bs-autohide","true"),o.setAttribute("data-bs-delay",t.delay.toString())):o.setAttribute("data-bs-autohide","false");const a=document.createElement("div");o.appendChild(a),a.className="toast-header",a.innerHTML=`<i class="${t.icon} me-2"></i> <strong class="me-auto">${t.header}</strong><small>${(new Date).toLocaleString()}</small><button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>`;const i=document.createElement("div");o.appendChild(i),i.className="toast-body",i.innerHTML=t.body,this.toastContainer.appendChild(o),this.toastElement=o,this.toastElement.addEventListener("hidden.bs.toast",(()=>{this.toastElement&&this.toastContainer?.removeChild(this.toastElement),this.toastElement=void 0,this.toast=void 0})),this.toast=new window.bootstrap.Toast(o),this.toast.show()}},t.launchSysNotification=function(e,t,n=!1){("hidden"===document.visibilityState||n)&&new Notification(e,{lang:"en-US",badge:"/assets/notifications/badge.png",body:t,icon:"/assets/notifications/icon.png"})}},700:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.SpectrumPlot=t.CalculateFWHM=t.SeekClosest=void 0;const a=o(n(892));class i{static seekWidth=2;isoList;constructor(e){const t={},n=Object.keys(e);for(const o of n){const n=e[o];for(const e of n)t[e]=o}this.isoList=t}seek(e,t=i.seekWidth){const n=Object.keys(this.isoList).filter((n=>!!n&&Math.abs(parseFloat(n)-e)<=t)).map((e=>parseFloat(e)));if(n.length){const t=n.reduce(((t,n)=>Math.abs(n-e)<Math.abs(t-e)?n:t)),o=this.isoList[t];if(o)return{energy:t,name:o}}return{energy:void 0,name:void 0}}}t.SeekClosest=i;class s{static resolutionLimit=.5;static fastMode=!1;peakList;calibratedBins;yAxis;constructor(e,t,n){this.peakList=e.sort(((e,t)=>e-t)),this.calibratedBins=t,this.yAxis=n}energyToBin(){const e=this.peakList.length,t=this.calibratedBins.length,n=[];let o=0;for(let a=0;a<t&&!(this.calibratedBins[a]>this.peakList[o]&&(n.push(a),o++,o>=e));a++);return n}compute(){const e=this.energyToBin(),t={};for(const n in e){const o=e[n],a=this.peakList[n],i=a*s.resolutionLimit,r=a-i/2,l=this.yAxis[o]/2;let c=o,d=this.calibratedBins[c],m=this.yAxis[c];for(;d>r&&m>l;)c--,d=this.calibratedBins[c],m=this.yAxis[c];const u=a-(d+this.calibratedBins[c+1])/2;if(s.fastMode){t[a]=2*u;continue}const h=a+i/2;let g=o,p=this.calibratedBins[g],f=this.yAxis[g];for(;p<h&&f>l;)g++,p=this.calibratedBins[g],f=this.yAxis[g];const y=(p+this.calibratedBins[g-1])/2-a;t[a]=u+y}return t}getResolution(){const e=this.compute(),t={};for(const[n,o]of Object.entries(e)){const e=parseFloat(n);t[e]=o/e}return t}}t.CalculateFWHM=s,t.SpectrumPlot=class{plotDiv;type="default";xAxis="linear";yAxis="linear";linePlot=!1;downloadFormat="png";darkMode=!1;plotBgDark="#3f4448";plotBgLight="#ffffff";paperBgDark="#212529";paperBgLight="#ffffff";fontColorLight="#444444";fontColorDark="#dee2e6";gridColorLight="#eeeeee";gridColorDark="#515151";annoBgLight="rgba(255,255,255,0.4)";annoBgDark="rgba(0,0,0,0.4)";cpsSwitchLimit=1;evolutionPointLimit=1e4;sma=!1;smaLength=8;calibration={enabled:!1,imported:!1,points:{aFrom:0,aTo:0,bFrom:0,bTo:0,cFrom:0,cTo:0},coeff:{c1:0,c2:0,c3:0}};cps=!1;shapes=[];annotations=[];editableMode=!1;isotopeSeeker;peakConfig={enabled:!1,mode:void 0,thres:.008,lag:50,showFWHM:!0,newPeakStyle:!0,lines:[]};gaussSigma=2;customDownloadButton={name:"downloadPlot",title:"Download plot as HTML",icon:window.Plotly.Icons.disk,direction:"up",click:e=>{const t=JSON.parse(JSON.stringify(e.layout));t.images[0].source=new URL("/assets/logo.svg",window.location.origin).href;const n={x:1,y:0,opacity:.9,xref:"paper",yref:"paper",xanchor:"right",yanchor:"bottom",text:window.location.origin,showarrow:!1,font:{size:10}};t.annotations.push(n);const o=`      <!DOCTYPE html>\n      \x3c!-- Gamma MCA Interactive Export Version 1.2 by NuclearPhoenix. https://spectrum.nuclearphoenix.xyz. --\x3e\n      <html>\n        <head>\n          <meta charset="utf-8">\n        </head>\n        <body style="margin:0;padding:0">\n          <div id="plotly-output" style="width:99vw;height:99vh"></div>\n          <script src="${new URL("https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.29.0/plotly-basic.min.js",window.location.origin)}"><\/script>\n          <script type="text/javascript">Plotly.newPlot('plotly-output',${JSON.stringify(e.data)},${JSON.stringify(t)},${JSON.stringify({responsive:!0,displaylogo:!1,toImageButtonOptions:{filename:"gamma_mca_export"}})})<\/script>\n        </body>\n      </html>      `,a=document.createElement("a");a.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(o)}`),a.setAttribute("download","gamma_mca_export.html"),a.style.display="none",a.click()}};customFullscreenButton={name:"fullscreen",title:"Toggle Fullscreen",icon:window.Plotly.Icons.drawrect,direction:"up",click:e=>{e.classList.toggle("fullscreen"),window.Plotly.update(e)}};gaussValues={dataArray:[],sigma:0};constructor(e){this.plotDiv=document.getElementById(e)}getXAxis(e,t=1){const n=[];for(let o=0;o<e;o+=t)n.push(o);return n}clearCalibration(){this.calibration.points={aFrom:0,aTo:0,bFrom:0,bTo:0,cFrom:0,cTo:0},this.calibration.coeff={c1:0,c2:0,c3:0},this.calibration.imported=!1}async computeCoefficients(){const e=[{x:this.calibration.points.aFrom,y:this.calibration.points.aTo},{x:this.calibration.points.bFrom,y:this.calibration.points.bTo}];this.calibration.points.cFrom&&this.calibration.points.cTo&&e.push({x:this.calibration.points.cFrom,y:this.calibration.points.cTo});const t=a.default.read(e,e.length-1).getTerms();this.calibration.coeff.c1=t[2]??0,this.calibration.coeff.c2=t[1],this.calibration.coeff.c3=t[0]}getCalAxis(e){const t=[],n=this.calibration.coeff.c1,o=this.calibration.coeff.c2,a=this.calibration.coeff.c3;for(let i=0;i<e;i++)t.push(n*i**2+o*i+a);return t}computeMovingAverage(e,t=this.smaLength){const n=Array(e.length),o=Math.round(t/2);for(let a=0;a<n.length;a++){if(a>=o&&a<=e.length-o-1){const i=e[a+o-t%2],s=e[a-o];n[a]=n[a-1]+(i-s)/t;continue}let i=0,s=0;for(let r=0;r<t;r++)r<o?a-r>=0&&(i+=e[a-r],s++):a-o+1+r<n.length&&(i+=e[a-o+1+r],s++);n[a]=i/s}return n}clearPeakFinder(){if(this.peakConfig.lines.length){const e=this.peakConfig.lines;for(const t of e)this.toggleLine(t,"",!1);this.peakConfig.lines=[]}}drawPeakFinder(e,t,n){for(let o of t){const t=Math.round(o),a=n[t];if(this.calibration.enabled&&(o=e[t]),a>=0)if("energy"===this.peakConfig.mode)this.toggleLine(o,Math.round(o).toString(),!0,a),this.peakConfig.lines.push(o);else if("isotopes"===this.peakConfig.mode){if(!this.isotopeSeeker)throw"No isotope seeker found!";const{energy:e,name:t}=this.isotopeSeeker.seek(o);e&&t&&(this.toggleLine(e,t,!0,a),this.peakConfig.lines.push(e))}}}peakFinder(e){this.clearPeakFinder();const t=this.getXAxis(e.length),n=this.computeMovingAverage(e,this.peakConfig.lag),o=Math.max(...e),a=[],i=e.length;for(let s=0;s<i;s++)e[s]-n[s]>this.peakConfig.thres*o&&a.push(t[s]);let s=[];a.push(0);const r=a.length,l=[];for(let e=0;e<r;e++)if(s.push(a[e]),Math.abs(a[e+1]-a[e])>2){let t=0;if(1===s.length)t=a[e];else{for(const e of s)t+=e;t/=s.length}l.push(t),s=[]}return l}resetPlot(e,t=[]){"calibration"===this.type&&this.plotCalibration(e,!1),"evolution"===this.type&&this.plotEvolution(t,!1),this.plotData(e,!1)}updatePlot(e,t=[]){"calibration"===this.type&&this.plotCalibration(e,!0),"evolution"===this.type&&this.plotEvolution(t,!0),this.plotData(e,!0)}toggleLine(e,t,n=!0,o=-1){const a=e.toFixed(2);if(n){const n={type:"line",xref:"x",yref:"paper",x0:e,y0:0,x1:e,y1:1,editable:!1,line:{color:"blue",width:.8,dash:"dot"},opacity:.66},i={x:"log"===this.xAxis?Math.log10(e):e,y:1,xref:"x",yref:"paper",text:t,showarrow:!0,arrowcolor:this.darkMode?this.fontColorDark:this.fontColorLight,arrowhead:7,ax:0,ay:-20,editable:!1,hovertext:a,font:{size:11}};o>=0&&this.peakConfig.newPeakStyle&&(n.y0=0,n.y1=0,n.line.width=0,i.y=1.03*("log"===this.yAxis?Math.log10(o):o),i.yref="y",i.arrowhead=1,i.arrowsize=.8,i.ay=-40,i.bgcolor=this.darkMode?this.annoBgDark:this.annoBgLight);for(const e of this.shapes)if(e.x0===n.x0)return;for(const e of this.annotations)if(e.hovertext===i.hovertext)return;this.shapes.push(n),this.annotations.push(i)}else{for(const t in this.shapes)this.shapes[t].x0===e&&this.shapes.splice(parseInt(t),1);for(const e in this.annotations)this.annotations[e].hovertext===a&&this.annotations.splice(parseInt(e),1)}}clearAnnos(){this.shapes=[],this.annotations=[]}setChartType(e,t,n=[]){switch(this.type=e,e){case"evolution":this.plotEvolution(n,!1);break;case"calibration":this.plotCalibration(t,!1);break;default:this.plotData(t,!1)}}computeGaussValues(e,t,n){const o=[];for(let a=t;a<n;a++)o.push(Math.exp(-a*a/(2*e)));let a=0;for(const e of o)a+=e;a/=n-t;let i=0;for(const e of o)i+=(e-a)*(e-a);for(const e in o)o[e]=(o[e]-a)/i;return o}gaussianCorrel(e,t=2){const n=Array(e.length);let o=!1;e.length===this.gaussValues.dataArray.length&&t===this.gaussValues.sigma||(this.gaussValues.dataArray=Array(e.length),this.gaussValues.sigma=t,o=!0);for(let a=0;a<e.length;a++){const i=Math.sqrt(a),s=-Math.round(t*i),r=Math.round(t*i);o&&(this.gaussValues.dataArray[a]=this.computeGaussValues(a,s,r));const l=this.gaussValues.dataArray[a];let c=0;for(let t=s;t<r;t++)c+=e[a+t]*l[t-s];const d=c&&c>0?c:0;n[a]=d}const a=.8*Math.max(...e)/Math.max(...n);return n.forEach(((e,t,n)=>n[t]=e*a)),n}limitArraySize(e,t){if(t<=1)return e;const n=[],o=e.length;for(let a=0;a<o;a+=t){const o=e.slice(a,a+t),i=o.reduce(((e,t)=>e+t),0)/o.length;n.push(i)}return n}plotEvolution(e,t){const n=Math.ceil(e.length/this.evolutionPointLimit),o=this.getXAxis(e.length,n),a=this.limitArraySize(e,n),i={name:"Radiation Evolution",x:o,y:a,mode:"lines",type:"scatter",line:{color:"orangered",width:1.5,shape:"spline"}},s={name:"Moving Average",x:o,y:this.computeMovingAverage(a),mode:"lines",type:"scatter",line:{color:"darkblue",width:2,shape:"spline"}},r={uirevision:1,autosize:!0,title:"Radiation Evolution",hovermode:"x",legend:{orientation:"h",y:-.35},xaxis:{title:"Measurement Point [1]",mirror:!0,linewidth:2,autorange:!0,autorangeoptions:{minallowed:0},rangeslider:{borderwidth:1},showspikes:!0,spikethickness:1,spikedash:"solid",spikecolor:"blue",spikemode:"across",ticksuffix:"",hoverformat:",.2~f",exponentformat:"none",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},yaxis:{title:"Counts Per Second [s<sup>-1</sup>]",mirror:!0,linewidth:2,autorange:!0,showspikes:!0,spikethickness:1,spikedash:"solid",spikecolor:"blue",spikemode:"across",showticksuffix:"last",ticksuffix:"cps",hoverformat:".4~s",exponentformat:"SI",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},plot_bgcolor:this.darkMode?this.plotBgDark:this.plotBgLight,paper_bgcolor:this.darkMode?this.paperBgDark:this.paperBgLight,font:{color:this.darkMode?this.fontColorDark:this.fontColorLight},margin:{l:40,r:40,b:50,t:55},images:[{x:.99,y:.99,opacity:.4,sizex:.15,sizey:.15,source:"/assets/logo.svg",xanchor:"right",xref:"paper",yanchor:"top",yref:"paper"}],annotations:[]},l={responsive:!0,scrollZoom:!1,displaylogo:!1,toImageButtonOptions:{format:this.downloadFormat,filename:"gamma_mca_evolution"},editable:this.editableMode,modeBarButtons:[["zoom2d"],["zoomIn2d","zoomOut2d"],["autoScale2d","resetScale2d"],["toImage"],[this.customDownloadButton],[this.customFullscreenButton]]};window.Plotly[t?"react":"newPlot"](this.plotDiv,[i,s],r,l)}plotCalibration(e,t){const n={name:"Calibration",x:this.getXAxis(e.data.length),y:this.getCalAxis(e.data.length),mode:"lines",type:"scatter",fill:"tozeroy",line:{color:"orangered",width:1}},o={name:"Calibration Points",x:[],y:[],mode:"text+markers",type:"scatter",marker:{size:8,color:"#444444"},text:[],textposition:"top center"};if(this.calibration.points){const e=["a","b","c"];for(const t in e){const n=e[t],a=`${n}From`,i=`${n}To`;if(a in this.calibration.points&&i in this.calibration.points){const e=this.calibration.points[a],n=this.calibration.points[i];e&&n&&(o.x.push(e),o.y.push(n),o.text?.push("Point "+(parseInt(t)+1).toString()))}}}const a={uirevision:1,autosize:!0,title:"Calibration",hovermode:"x",legend:{orientation:"h",y:-.35},xaxis:{title:"Bin [1]",mirror:!0,linewidth:2,autorange:!0,autorangeoptions:{minallowed:0},rangeslider:{borderwidth:1},showspikes:!0,spikethickness:1,spikedash:"solid",spikecolor:"blue",spikemode:"across",ticksuffix:"",hoverformat:",.2~f",exponentformat:"none",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},yaxis:{title:"Energy [keV]",mirror:!0,linewidth:2,autorange:!0,autorangeoptions:{minallowed:0},showspikes:!0,spikethickness:1,spikedash:"solid",spikecolor:"blue",spikemode:"across",showticksuffix:"last",ticksuffix:" keV",showexponent:"last",exponentformat:"none",hoverformat:",.2~f",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},plot_bgcolor:this.darkMode?this.plotBgDark:this.plotBgLight,paper_bgcolor:this.darkMode?this.paperBgDark:this.paperBgLight,font:{color:this.darkMode?this.fontColorDark:this.fontColorLight},margin:{l:40,r:40,b:50,t:55},images:[{x:.99,y:.99,opacity:.4,sizex:.15,sizey:.15,source:"/assets/logo.svg",xanchor:"right",xref:"paper",yanchor:"top",yref:"paper"}],annotations:[]},i={responsive:!0,scrollZoom:!1,displaylogo:!1,toImageButtonOptions:{format:this.downloadFormat,filename:"gamma_mca_calibration"},editable:this.editableMode,modeBarButtons:[["zoom2d"],["zoomIn2d","zoomOut2d"],["autoScale2d","resetScale2d"],["toImage"],[this.customDownloadButton],[this.customFullscreenButton]]};window.Plotly[t?"react":"newPlot"](this.plotDiv,[n,o],a,i)}computePulseHeightData(e){const t=[];if(e.data.length){const n={name:"Spectrum",stackgroup:"data",x:this.getXAxis(e.data.length),y:e.data,type:"scatter",mode:"lines",fill:this.linePlot?"none":"tonexty",line:{color:"orangered",width:1,shape:this.linePlot?"linear":"hvh"}};this.cps&&(n.y=e.dataCps),t.push(n)}if(e.background.length){const n={name:"Background",stackgroup:"data",x:this.getXAxis(e.background.length),y:e.background,type:"scatter",mode:"lines",fill:this.linePlot?"none":"tonexty",line:{color:"slategrey",width:1,shape:this.linePlot?"linear":"hvh"}};if(this.cps&&(n.y=e.backgroundCps),t.length){const e=[],o=t[0].y.length;for(let a=0;a<o;a++)e.push(t[0].y[a]-n.y[a]);t[0].y=e,t[0].name="Net Spectrum"}t.push(n)}if(this.sma)for(const e of t)e.y=this.computeMovingAverage(e.y);if(this.calibration.enabled)for(const e of t)e.x=this.getCalAxis(e.x.length);if(this.peakConfig.enabled&&t.length){const e=this.gaussianCorrel(t[0].y,this.gaussSigma),n={name:"Gaussian Correlation",x:t[0].x,y:e,type:"scatter",mode:"lines",line:{color:"black",width:.6,shape:this.linePlot?"linear":"hvh"},marker:{color:"black"}};t.unshift(n)}return t}plotData(e,t){if("default"!==this.type)return;const n={uirevision:1,autosize:!0,title:"Energy Spectrum",hovermode:"x",legend:{orientation:"h",y:-.35},selectdirection:"h",activeselection:{fillcolor:"blue",opacity:.01},newselection:{line:{color:"blue",width:1,dash:"solid"}},xaxis:{title:"Bin [1]",mirror:!0,linewidth:2,autorange:!0,autorangeoptions:{minallowed:0},type:this.xAxis,rangeslider:{borderwidth:1},showspikes:!0,spikethickness:1,spikedash:"solid",spikecolor:"blue",spikemode:"across",hoverformat:",.2~f",ticksuffix:"",exponentformat:"none",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},yaxis:{title:"Counts [1]",mirror:!0,linewidth:2,autorange:!0,fixedrange:!1,type:this.yAxis,showticksuffix:"last",ticksuffix:"cts",hoverformat:".4~s",exponentformat:"SI",automargin:!0,gridcolor:this.darkMode?this.gridColorDark:this.gridColorLight},plot_bgcolor:this.darkMode?this.plotBgDark:this.plotBgLight,paper_bgcolor:this.darkMode?this.paperBgDark:this.paperBgLight,font:{color:this.darkMode?this.fontColorDark:this.fontColorLight},margin:{l:40,r:40,b:50,t:this.peakConfig.newPeakStyle?55:80},images:[{x:.99,y:.99,opacity:.4,sizex:.15,sizey:.15,source:"/assets/logo.svg",xanchor:"right",xref:"paper",yanchor:"top",yref:"paper"}],shapes:[],annotations:[]};this.calibration.enabled&&(n.xaxis.title="Energy [keV]",n.xaxis.ticksuffix=" keV");const o={responsive:!0,scrollZoom:!1,displaylogo:!1,toImageButtonOptions:{format:this.downloadFormat,filename:"gamma_mca_spectrum"},editable:this.editableMode,modeBarButtons:[["select2d"],["zoom2d"],["zoomIn2d","zoomOut2d"],["autoScale2d","resetScale2d"],["toImage"],[this.customDownloadButton],[this.customFullscreenButton]]},a=this.computePulseHeightData(e);if(this.cps&&a.length>0)if(Math.max(...a[0].y)<this.cpsSwitchLimit){for(const e of a)e.y=e.y.map((e=>60*e));n.yaxis.title="Counts Per Minute [60 s<sup>-1</sup>]",n.yaxis.ticksuffix="cpm"}else n.yaxis.title="Counts Per Second [s<sup>-1</sup>]",n.yaxis.ticksuffix="cps";if(this.peakConfig.enabled&&a.length>1){const e=a[0].x,t=a[0].y,n=this.peakFinder(t);if(this.drawPeakFinder(e,n,a[1].y),this.peakConfig.showFWHM){const e=new s(this.peakConfig.lines,a[1].x,a[1].y).getResolution();for(const t of this.annotations){const n=e[t.x];n>0&&n<.9*s.resolutionLimit&&(t.text+=`<br>${(100*n).toFixed(1)}%`)}}}if((!this.peakConfig.enabled||!a.length||a.length>=3)&&a.reverse(),n.shapes=this.shapes,n.annotations=JSON.parse(JSON.stringify(this.annotations)),this.calibration.enabled)for(const e of n.annotations)e.hovertext+=n.xaxis.ticksuffix;window.Plotly[t?"react":"newPlot"](this.plotDiv,a,n,o)}}},528:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.RawData=void 0;const a=o(n(892));t.RawData=class{valueIndex;delimiter;adcChannels=4096;fileType;tempValIndex;schemaURLTable={NPESv1:"/assets/npes-1.schema.json",NPESv2:"/assets/npes-2.schema.json"};schemaJSON={NPESv1:void 0,NPESv2:void 0};constructor(e,t=","){this.valueIndex=e,this.delimiter=t,this.adcChannels,this.fileType=e,this.tempValIndex=e}checkLines(e){const t=e.split(this.delimiter);return!isNaN(parseFloat(t[0].trim()))&&(1===t.length&&(this.tempValIndex=0),t.length>this.tempValIndex)}parseLines(e){const t=e.split(this.delimiter);return parseFloat(t[this.tempValIndex].trim())}histConverter(e){const t=Array(this.adcChannels).fill(0);for(const n of e)t[n]+=1;return t}parseCalibration(e){if(!this.tempValIndex)return;if(e.length<3)return;const t=e.map((e=>parseFloat(e.split(this.delimiter)[0].trim()))),n=[];for(const e in t){const o={x:parseInt(e),y:t[e]};n.push(o)}const o=a.default.read(n,3).getTerms();return o.pop(),o.reverse()}csvToArray(e){this.tempValIndex=this.valueIndex;const t={histogramData:[],calibrationCoefficients:void 0};if(1===this.fileType){const n=e.split("\n").filter(this.checkLines,this);t.calibrationCoefficients=this.parseCalibration(n),t.histogramData=n.map(this.parseLines,this)}else{const n=e.split(this.delimiter).filter(this.checkLines,this);t.histogramData=this.histConverter(n.map(this.parseLines,this))}return t}xmlToArray(e){const t={c1:0,c2:0,c3:0},n={name:"",location:"",time:"",notes:"",deviceName:"",startTime:"",endTime:"",dataMt:0,backgroundMt:0};try{const o=(new DOMParser).parseFromString(e,"text/xml"),a=o.getElementsByTagName("EnergySpectrum");let i=[],s=[];if(a[0]){const e=a[0].getElementsByTagName("DataPoint");i=Array.from(e).map((e=>parseFloat(e.textContent??"-1"))),n.dataMt=parseFloat(a[0].getElementsByTagName("MeasurementTime")[0]?.textContent?.trim()??"1")}const r=o.getElementsByTagName("BackgroundEnergySpectrum");if(r[0]){const e=r[0].getElementsByTagName("DataPoint");s=Array.from(e).map((e=>parseFloat(e.textContent??"-1"))),n.backgroundMt=parseFloat(r[0].getElementsByTagName("MeasurementTime")[0]?.textContent?.trim()??"1")}const l=o.getElementsByTagName("EnergySpectrum")[0];if(l){const e=l.getElementsByTagName("Coefficient"),n=Array.from(e).map((e=>parseFloat(e.textContent??"0")));for(const e in n)t["c"+(parseInt(e)+1).toString()]=n[2-parseInt(e)]}const c=o.getElementsByTagName("SampleInfo")[0];n.name=c?.getElementsByTagName("Name")[0]?.textContent?.trim()??"",n.location=c?.getElementsByTagName("Location")[0]?.textContent?.trim()??"",n.time=c?.getElementsByTagName("Time")[0]?.textContent?.trim()??"",n.notes=c?.getElementsByTagName("Note")[0]?.textContent?.trim()??"";let d=parseFloat(c?.getElementsByTagName("Weight")[0]?.textContent?.trim()??"0");return d>0&&(n.weight=1e3*d),d=parseFloat(c?.getElementsByTagName("Volume")[0]?.textContent?.trim()??"0"),d>0&&(n.volume=1e3*d),n.deviceName=o.getElementsByTagName("DeviceConfigReference")[0]?.getElementsByTagName("Name")[0]?.textContent?.trim()??"",n.startTime=o.getElementsByTagName("StartTime")[0]?.textContent?.trim()??"",n.endTime=o.getElementsByTagName("EndTime")[0]?.textContent?.trim()??"",{espectrum:i,bgspectrum:s,coeff:t,meta:n}}catch(e){return console.error(e),{espectrum:[],bgspectrum:[],coeff:t,meta:n}}}async jsonToObject(e){let t,n;try{t=JSON.parse(e)}catch(e){return console.error(e),[{code:"JSON_PARSE_ERROR",description:`A problem with the JSON formatting occured when trying to parse the contents of the file: ${e}`}]}try{if("NPESv1"!==t.schemaVersion&&"NPESv2"!==t.schemaVersion)throw`schemaVersion is neither NPESv1 nor NPESv2, but ${t.schemaVersion}!`;n=t.schemaVersion}catch(e){return console.error(e),[{code:"NPES_VERSION_ERROR",description:`An error occured when trying to parse the schema version: ${e}`}]}try{if(!this.schemaJSON[n]){const e=await fetch(this.schemaURLTable[n]);if(!e.ok)throw"Could not load the schema file!";{const t=await e.json();delete t.$schema,this.schemaJSON[n]=t}}const e=new window.ZSchema;e.validate(t,this.schemaJSON[n]);const o=e.getLastErrors();if(o){const e=[];for(const t of o)e.push({code:t.code,description:t.message});return console.error(e),e}return"NPESv1"===n?[t]:t.data}catch(e){return console.error(e),[{code:"UNDEFINED_ERROR",description:`Some undefined error occured: ${e}`}]}}}},160:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.SerialManager=t.WebSerial=t.WebUSBSerial=void 0;const o=n(548);t.WebUSBSerial=class{port;device;isOpen=!1;static deviceFilters=[{vendorId:1027}];constructor(e){this.device=e,console.info("WebUSB product name:",e.productName),console.info("WebUSB manufacturer name:",e.manufacturerName)}async sendString(e){const t=new TextEncoder;this.port?.send(t.encode(`${e}\n`))}buffer=new Uint8Array(102400);pos=0;async read(){if(0===this.pos)return await new Promise((e=>setTimeout(e,100))),new Uint8Array;const e=this.buffer.subarray(0,this.pos);return this.pos=0,e}serOptions={overridePortSettings:!0,baudrate:115200};async open(e){this.serOptions.baudrate=e,this.port=new o.WebUSBSerialPort(this.device,this.serOptions),this.pos=0,this.port.connect((e=>{this.buffer.set(e,this.pos),this.pos+=e.length}),(e=>{console.error("Error receiving data!"+e),this.isOpen=!1})),this.isOpen=!0}async close(){this.isOpen&&(this.isOpen=!1,this.port?.disconnect())}isThisPort(e){return this.device===e}getInfo(){return this.device.productName}getPort(){return this.device}},t.WebSerial=class{port;isOpen=!1;constructor(e){this.port=e}isThisPort(e){return this.port===e}async sendString(e){if(!this.isOpen)return;if(!this.port?.writable)throw"Port is not writable!";const t=new TextEncoderStream,n=t.writable.getWriter(),o=t.readable.pipeTo(this.port.writable);n.write(e.trim()+"\n"),await n.close(),await o}reader;async read(){let e=new Uint8Array;if(!this.isOpen)return e;if(this.port.readable)try{this.reader=this.port.readable.getReader();const{value:t}=await this.reader.read();t&&(e=t)}finally{this.reader?.releaseLock(),this.reader=void 0}else await this.close();return e}serOptions={baudRate:9600};async open(e){this.serOptions.baudRate=e,await this.port.open(this.serOptions),this.isOpen=!0}async close(){this.isOpen&&(this.reader&&await(this.reader?.cancel()),await(this.port?.close()),this.isOpen=!1)}getInfo(){return`ID: 0x${this.port.getInfo().usbProductId?.toString(16).toUpperCase()}`}getPort(){return this.port}};class a{port;closed;recording=!1;onlyConsole=!0;startTime=0;timeDone=0;static orderType="chron";static baudRate=9600;consoleMemory=1e3;consoleMemoryTotal=1e5;rawConsoleData="";rawData="";maxHistLength=5242880;maxLength=20;bufferPulseData=[];baseHist=[];static maxSize=2e5;static adcChannels=4096;static eolChar=";";constructor(e){this.port=e}isThisPort(e){return this.port.isThisPort(e)}async sendString(e){await this.port.sendString(e)}async showConsole(){this.recording||(this.port.isOpen||await this.port.open(a.baudRate),this.recording=!0,this.onlyConsole=!0,this.closed=this.readUntilClosed())}async hideConsole(){if(this.recording&&this.onlyConsole){this.onlyConsole=!1,this.recording=!1;try{await this.port.close()}catch(e){console.warn("Nothing to disconnect.",e)}await this.closed}}async stopRecord(){if(this.recording){this.recording=!1,this.timeDone+=performance.now()-this.startTime;try{await this.port.close()}catch(e){console.warn("Nothing to disconnect.",e)}await this.closed}}async startRecord(e=!1){this.recording||(this.port.isOpen||await this.port.open(a.baudRate),e||(this.flushData(),this.clearBaseHist(),this.timeDone=0),this.startTime=performance.now(),this.recording=!0,this.onlyConsole=!1,this.closed=this.readUntilClosed())}async readUntilClosed(){for(;this.port.isOpen&&this.recording;){const e=await this.port.read();e.length&&this.addRaw(e)}await this.port.close()}addRaw(e){const t=new TextDecoder("utf-8").decode(e);this.rawConsoleData+=t;const n=this.rawConsoleData.split("\n");if(n.pop(),(n.length>this.consoleMemory||this.rawConsoleData.length>this.consoleMemoryTotal)&&(this.rawConsoleData=this.rawConsoleData.replace(n[0]+"\n","")),!this.onlyConsole)if(this.bufferPulseData.length>a.maxSize)console.warn("Warning: Serial buffer is saturating!");else if(this.rawData+=t,"chron"===a.orderType){const e=this.rawData.split(a.eolChar);if(e.pop(),e.shift(),e.length<=1)return void(this.rawData.length>this.maxLength&&(this.rawData=""));for(const t of e){this.rawData=this.rawData.replace(t+a.eolChar,"");const e=t.trim();if(!e.length||e.length>=this.maxLength)continue;const n=parseInt(e);isNaN(n)||n<0||n>a.adcChannels||this.bufferPulseData.push(n)}}else if("hist"===a.orderType){const e=this.rawData.split("\n");if(e.pop(),!e.length)return void(this.rawData.length>this.maxHistLength&&(this.rawData=""));for(const t of e){this.rawData=this.rawData.replace(t+"\n","");const e=t.trim();if(!e.length||e.length>=this.maxHistLength)continue;const n=e.split(a.eolChar);if(n.pop(),n.length!==a.adcChannels)continue;const o=n.map((e=>{const t=parseInt(e);return isNaN(t)?0:t}));if(!this.baseHist.length)return this.baseHist=o,void(this.startTime=performance.now());const i=o.map(((e,t)=>e-this.baseHist[t]));this.bufferPulseData.length||(this.bufferPulseData=Array(a.adcChannels).fill(0));for(const e in this.bufferPulseData)this.bufferPulseData[e]+=i[e];this.baseHist=o}}}flushData(){this.rawData="",this.bufferPulseData=[]}clearBaseHist(){this.baseHist=[]}flushRawData(){this.rawConsoleData=""}getRawData(){return this.rawConsoleData}getData(){const e=[...this.bufferPulseData];return this.bufferPulseData=[],e}getTime(){return this.recording?performance.now()-this.startTime+this.timeDone:this.timeDone}}t.SerialManager=a},892:(e,t,n)=>{n.r(t),n.d(t,{default:()=>i});class o{backwardSubstitution(e,t,n,o){if(n<0||o<0)return t;{const a=e.length,i=e[0].length-1;let s=0,r=0;for(let l=i-1;l>=o;l--)l===o?s=e[n][i]/e[n][l]:(e[n][i]-=e[n][l]*t[a-1-r],r++);return t[n]=s,this.backwardSubstitution(e,t,n-1,o-1)}}combineMatrices(e,t){const n=t.length,o=e[0].length,a=[];for(let i=0;i<n;i++){a.push([]);for(let n=0;n<=o;n++)a[i][n]=n===o?t[i]:e[i][n]}return a}forwardElimination(e){const t=e.length,n=e[0].length,o=[];for(let a=0;a<t;a++){o.push([]);for(let t=0;t<n;t++)o[a][t]=e[a][t]}for(let e=0;e<t-1;e++)for(let a=e;a<t-1;a++){const t=o[a+1][e]/o[e][e];for(let i=0;i<n;i++)o[a+1][i]=o[a+1][i]-t*o[e][i]}return o}gaussianJordanElimination(e,t){const n=this.combineMatrices(e,t),o=this.forwardElimination(n);return this.backwardSubstitution(o,[],o.length-1,o[0].length-2)}identityMatrix(e){const t=e.length,n=e[0].length,o=[[]];for(let e=0;e<t;e++)for(let t=0;t<n;t++)o[e][t]=t===e?1:0;return o}matrixProduct(e,t){const n=e[0].length,o=t.length;if(n!==o)return!1;const a=[[]];for(let i=0;i<o;i++)for(let o=0;o<n;o++)a[i][o]=this.doMultiplication(e,t,i,o,n);return a}doMultiplication(e,t,n,o,a){let i=0,s=0;for(;i<a;)s+=e[n][i]*t[i][o],i++;return s}multiplyRow(e,t,n){const o=e.length,a=e[0].length,i=[[]];for(let s=0;s<o;s++)for(let o=0;o<a;o++)i[s][o]=s===t?e[s][o]*n:e[s][o];return i}}class a{constructor(e,t){this.x=e,this.y=t}}class i{static read(e,t){const n=e.map((e=>new a(e.x,e.y)));return new i(n,t)}constructor(e,t){this.data=e,this.degree=t,this.matrix=new o,this.leftMatrix=[],this.rightMatrix=[],this.generateLeftMatrix(),this.generateRightMatrix()}sumX(e,t){let n=0;for(let o=0;o<e.length;o++)n+=Math.pow(e[o].x,t);return n}sumXTimesY(e,t){let n=0;for(let o=0;o<e.length;o++)n+=Math.pow(e[o].x,t)*e[o].y;return n}sumY(e,t){let n=0;for(let o=0;o<e.length;o++)n+=Math.pow(e[o].y,t);return n}generateLeftMatrix(){for(let e=0;e<=this.degree;e++){this.leftMatrix.push([]);for(let t=0;t<=this.degree;t++)this.leftMatrix[e][t]=0===e&&0===t?this.data.length:this.sumX(this.data,e+t)}}generateRightMatrix(){for(let e=0;e<=this.degree;e++)this.rightMatrix[e]=0===e?this.sumY(this.data,1):this.sumXTimesY(this.data,e)}getTerms(){return this.matrix.gaussianJordanElimination(this.leftMatrix,this.rightMatrix)}predictY(e,t){let n=0;for(let o=e.length-1;o>=0;o--)n+=0===o?e[o]:e[o]*Math.pow(t,o);return n}}},548:(e,t,n)=>{n.r(t),n.d(t,{WebUSBSerialPort:()=>o});class o{#e=0;#t=1;#n=2;#o=3;#a=4;#i=5;#s=6;#r=7;#l=9;#c=10;#d=11;#m=12;#u=144;#h=0;#g=1;#p=2;#f=4;#y=8;#b=16;#w=32;#k=64;#E=1;#v=2;#x=3;#C=4;#I=0;#B=1;#S=2;#T=3;#N=this.#e;#M="vendor";#L=0;#D=1;#P=2;#F=3;#A={SIO:1,FT8U232AM:2,FT232BM:3,FT2232C:4,FT232RL:5,FT2232H:6,FT4232H:7,FT232H:8,FTX:9};#O={ftdi_sio_b300:0,ftdi_sio_b600:1,ftdi_sio_b1200:2,ftdi_sio_b2400:3,ftdi_sio_b4800:4,ftdi_sio_b9600:5,ftdi_sio_b19200:6,ftdi_sio_b38400:7,ftdi_sio_b57600:8,ftdi_sio_b115200:9};#_=this.#a;#R=0;#H=256;#$=512;#U=768;#W=1024;#V=0;#j=2048;#z=4096;#J=16384;#q=this.#t;#Y=1;#X=this.#Y<<8|1;#G=this.#Y<<8|0;#Z=2;#K=this.#Z<<8|2;#Q=this.#Z<<8|0;#ee=this.#n;#te=0;#ne=256;#oe=512;#ae=1024;#ie=this.#c;#se=this.#l;#re=this.#s;#le=this.#i;#ce=16;#de=32;#me=64;#ue=128;#he=this.#d;#ge=0;#pe=32;#fe=this.#m;#ye=this.#u;#be=8;#we=10;#ke=16;#Ee=32;#ve=64;#xe=128;#Ce=1;#Ie=2;#Be=4;#Se=8;#Te=16;#Ne=32;#Me=64;#Le=128;constructor(e,t){this.device=e,this.portConfiguration=t,this.interfaceNumber=0,this.endpointIn=0,this.endpointOut=0,this.modemStatusByte=0,this.lineStatusByte=0,this.packetsReceived=0}connect(e,t){this.onReceive=e,this.onReceiveError=t;let n=()=>{this.device.transferIn(this.endpointIn,64).then((e=>{let t=new Uint8Array(e.data.buffer);if(t[0]!=this.modemStatusByte&&(this.modemStatusByte=t[0]),t[1]!=this.lineStatusByte&&(this.lineStatusByte=t[1]),t.length>2){let e=new Uint8Array(t.length-2);for(let n=2;n<t.length;n++)e[n-2]=t[n];this.onReceive(e)}else this.packetsReceived=this.packetsReceived+1;n()}),(e=>{this.onReceiveError(e)}))};return this.device.open().then((()=>{if(null===this.device.configuration)return this.device.selectConfiguration(1)})).then((()=>{this.device.configuration.interfaces.forEach((e=>{e.alternates.forEach((t=>{console.log(t),255==t.interfaceClass&&(this.interfaceNumber=e.interfaceNumber,t.endpoints.forEach((e=>{"out"==e.direction&&(this.endpointOut=e.endpointNumber),"in"==e.direction&&(this.endpointIn=e.endpointNumber)})))}))}))})).then((()=>this.device.claimInterface(this.interfaceNumber))).then((()=>this.device.selectAlternateInterface(this.interfaceNumber,0))).then((()=>{let e=this.portConfiguration.baudrate;this.device.controlTransferOut({requestType:"vendor",recipient:"device",request:this.#o,value:this.getBaudDivisor(e),index:this.getBaudBase()})})).then((()=>this.device.controlTransferIn({requestType:"vendor",recipient:"device",request:this.#ie,value:0,index:0},1))).then((e=>{if(this.device.latencyTimer=new Uint8Array(e.data.buffer)[0],1!=this.device.latencyTimer)return this.device.controlTransferOut({requestType:"vendor",recipient:"device",request:this.#se,value:1,index:0})})).then((e=>this.device.latencyTimer=this.device.controlTransferIn({requestType:"vendor",recipient:"device",request:this.#ie,value:0,index:0},1))).then((e=>(this.device.latencyTimer=new Uint8Array(e.data.buffer)[0],console.log("Current Latency Timer: "),console.log(this.device.latencyTimer),n(),this.device)))}DIV_ROUND_CLOSEST(e,t){return e-1>0||t-1>0||e>0==t>0?(e+t/2)/t:(e-t/2)/t}getBaudBase(){return 48e6}getBaudDivisor(e){let t=this.getBaudBase(),n=new Uint8Array(8);n=[0,3,2,4,1,5,6,7];let o=0,a=this.DIV_ROUND_CLOSEST(t,2*e);return o=a>>3,o|=n[7&a]<<14,1==o?o=0:16385==o&&(o=1),o}send(e){return this.device.transferOut(this.endpointOut,e)}disconnect(){this.device.close()}}}},t={};function n(o){var a=t[o];if(void 0!==a)return a.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{const e=n(700),t=n(528),o=n(160),a=n(496),i=n(544);const s=new class{data=[];background=[];dataCps=[];backgroundCps=[];dataTime=1e3;backgroundTime=1e3;getTotalCounts(e,t=0,n=this[e].length-1){const o=this[e];let a=0;if(t<0||t>=o.length||n<0||n>=o.length||t>n)return console.warn("Invalid sum range! Return default 0."),a;for(let e=t;e<=n;e++)a+=o[e];return a}addPulseData(e,t,n){this[e].length||(this[e]=Array(n).fill(0));for(const n of t)this[e][n]+=1}addHist(e,t){this[e].length||(this[e]=t);for(const n in t)this[e][n]+=t[n]}},r=new e.SpectrumPlot("plot"),l=new t.RawData(1),c={a:!1,b:!1,c:!1},d={a:"",b:"",c:""};let m=[],u=1e3,h=!1,g=18e5;const p=200,f=200,y=9e5;let b=[],w="assets/isotopes_energies_min.json";const k={};let E=!1,v=100;const x="2024-02-04",C="localStorage"in self,I="wakeLock"in navigator,B="Notification"in window;let S=B,T=!1,N=!1;const M=["none","none","none"],L={none:"fa-sort",asc:"fa-sort-up",desc:"fa-sort-down"},D={r:"reset-plot",s:"sma-label",x:"xAxis",y:"yAxis",c:"plot-cps",t:"plot-type",i:"iso-hover-label",p:"peak-finder-btn",1:"file-import-tab",2:"serial-tab",3:"sound-tab",4:"calibration-tab",5:"metadata-tab"};let P;async function F(){P.prompt(),await P.userChoice}function A(e){S=e,"granted"!==Notification.permission&&S&&Notification.requestPermission().then((e=>{"granted"===e&&(0,a.launchSysNotification)("Success!","Notifications for Gamma MCA are now enabled.",!0),S=S&&"granted"===e,document.getElementById("notifications-toggle").checked=S;const t=Ue("allowNotifications",S);new a.ToastNotification(t?"settingSuccess":"settingError")})),Be("ask-notifications"),document.getElementById("notifications-toggle").checked=S;const t=Ue("allowNotifications",S);new a.ToastNotification(t?"settingSuccess":"settingError")}function O(e){const t=document.getElementById("overwrite-button");t.disabled=!1,t.title=`Overwrite "${e}" with current data.`}window.addEventListener("DOMContentLoaded",(()=>{C&&(r.darkMode="dark"===(0,i.applyTheming)(),ee(!1))})),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(()=>{C&&(r.darkMode="dark"===(0,i.autoThemeChange)(),ee(!1))})),document.body.onload=async function(){if(T=window.FileSystemHandle&&"createWritable"in FileSystemFileHandle.prototype,C?function(){let t=We("allowNotifications");B&&null!==t&&(S=t&&"granted"===Notification.permission),t=We("customURL"),t&&(w=new URL(t).href),t=We("editMode"),null!==t&&(r.editableMode=t),t=We("fileDelimiter"),null!==t&&(l.delimiter=t),t=We("fileChannels"),null!==t&&(l.adcChannels=t),t=We("plotRefreshRate"),null!==t&&(u=t),t=We("serBufferSize"),null!==t&&(o.SerialManager.maxSize=t),t=We("timeLimitBool"),null!==t&&(h=t),t=We("timeLimit"),null!==t&&(g=t),t=We("maxIsoDist"),null!==t&&(v=t),t=We("baudRate"),null!==t&&(o.SerialManager.baudRate=t),t=We("eolChar"),null!==t&&(o.SerialManager.eolChar=t),t=We("serChannels"),null!==t&&(o.SerialManager.adcChannels=t),t=We("smaLength"),null!==t&&(r.smaLength=t),t=We("peakThres"),null!==t&&(r.peakConfig.thres=t),t=We("peakLag"),null!==t&&(r.peakConfig.lag=t),t=We("seekWidth"),null!==t&&(e.SeekClosest.seekWidth=t),t=We("plotDownload"),null!==t&&(r.downloadFormat=t),t=We("gaussSigma"),null!==t&&(r.gaussSigma=t),t=We("showEnergyRes"),null!==t&&(r.peakConfig.showFWHM=t),t=We("useFWHMFast"),null!==t&&(e.CalculateFWHM.fastMode=t),t=We("newPeakStyle"),null!==t&&(r.peakConfig.newPeakStyle=t)}():console.error("Browser does not support local storage. OOF, it must be ancient. Dude, update your browser. For real."),navigator.serviceWorker){const e=await navigator.serviceWorker.register("/service-worker.js");C&&e.addEventListener("updatefound",(()=>{N||(new a.ToastNotification("updateInstalled"),(0,a.launchSysNotification)("New Update!","An update has been installed and will be applied once you reload Gamma MCA."))}))}if("standalone"in window.navigator||window.matchMedia("(display-mode: standalone)").matches){document.title+=" PWA",document.getElementById("main").classList.remove("p-1");const e=document.getElementsByClassName("border-mode");for(const t of e)t.classList.add("border-0");document.getElementById("plot-tab").classList.add("border-start-0","border-end-0")}else document.getElementById("main").classList.remove("pb-1"),document.title+=" web application";if(w=new URL(w,window.location.origin).href,navigator.serial||navigator.usb){const e=document.getElementById("serial-error");e.parentNode.removeChild(e),navigator[navigator.serial?"serial":"usb"].addEventListener("connect",ze),navigator[navigator.serial?"serial":"usb"].addEventListener("disconnect",Je),qe()}else{const e=document.getElementById("serial-div");e.parentNode.removeChild(e);const t=document.getElementsByClassName("ser-settings");for(const e of t)e.disabled=!0;const n=document.getElementsByClassName("serial-controls");for(const e of n)e.disabled=!0}if("launchQueue"in window&&"LaunchParams"in window&&window.launchQueue.setConsumer((async e=>{if(!e.files.length)return;const t=await e.files[0].getFile(),n=t.name.split(".")[1].toLowerCase();T&&("json"!==n&&"xml"!==n||(R=e.files[0],O(R.name))),["csv","tka","xml","txt","json"].includes(n)&&V(t,"data"),console.warn("File could not be imported!")})),ee(),document.getElementById("version-tag").innerText+=` ${x}.`,C){We("lastVisit")<=0&&(new a.ToastNotification("welcomeMessage"),B&&Ie("ask-notifications"),N=!0),Ue("lastVisit",Date.now()),Ue("lastUsedVersion",x);const e=We("serialDataMode"),t=We("fileDataMode");if(e){const t=document.getElementById(e);t.checked=!0,je(t)}if(t){const e=document.getElementById(t);e.checked=!0,Q(e)}const n=document.getElementById("ls-unavailable");n.parentNode.removeChild(n);const o=We("consoleAutoscrollEnabled");o&&(ot=o,document.getElementById("autoscroll-console").checked=o)}else{const e=document.getElementById("ls-available");e.parentNode.removeChild(e),new a.ToastNotification("welcomeMessage")}!function(){B&&(document.getElementById("notifications-toggle").checked=S&&"granted"===Notification.permission),document.getElementById("custom-url").value=w,document.getElementById("edit-plot").checked=r.editableMode,document.getElementById("custom-delimiter").value=l.delimiter,document.getElementById("custom-file-adc").value=l.adcChannels.toString(),document.getElementById("custom-ser-refresh").value=(u/1e3).toString(),document.getElementById("custom-ser-buffer").value=o.SerialManager.maxSize.toString(),document.getElementById("custom-ser-adc").value=o.SerialManager.adcChannels.toString();const t=new Date(g);document.getElementById("ser-limit-h").value=(t.getUTCHours()+24*(t.getUTCDate()-1)).toString(),document.getElementById("ser-limit-m").value=t.getUTCMinutes().toString(),document.getElementById("ser-limit-s").value=t.getUTCSeconds().toString(),document.getElementById("toggle-time-limit").checked=h,document.getElementById("iso-hover-prox").value=v.toString(),document.getElementById("custom-baud").value=o.SerialManager.baudRate.toString(),document.getElementById("eol-char").value=o.SerialManager.eolChar,document.getElementById("sma-val").value=r.smaLength.toString(),document.getElementById("new-flags").checked=r.peakConfig.newPeakStyle,document.getElementById("enable-res").checked=r.peakConfig.showFWHM,document.getElementById("fwhm-fast").checked=e.CalculateFWHM.fastMode,document.getElementById("peak-thres").value=r.peakConfig.thres.toString(),document.getElementById("peak-lag").value=r.peakConfig.lag.toString(),document.getElementById("seek-width").value=e.SeekClosest.seekWidth.toString(),document.getElementById("gauss-sigma").value=r.gaussSigma.toString();const n=document.getElementById("download-format"),a=n.options.length,i=r.downloadFormat;for(let e=0;e<a;e++)n.options[e].value===i&&(n.selectedIndex=e);const s=document.getElementById("theme-select"),c=s.options.length,d=We("theme");for(let e=0;e<c;e++)s.options[e].value===d&&(s.selectedIndex=e)}(),Y(),function(){const e={"iso-hover-prox":"maxIsoDist","custom-url":"customURL","custom-delimiter":"fileDelimiter","custom-file-adc":"fileChannels","custom-baud":"baudRate","eol-char":"eolChar","ser-limit-h":"timeLimit","ser-limit-m":"timeLimit","ser-limit-s":"timeLimit","custom-ser-refresh":"plotRefreshRate","custom-ser-buffer":"serBufferSize","custom-ser-adc":"serChannels","peak-thres":"peakThres","peak-lag":"peakLag","seek-width":"seekWidth","gauss-sigma":"gaussSigma"};for(const[t,n]of Object.entries(e)){const e=document.getElementById(t);e.onkeydown=t=>{"Enter"===t.key&&Ve(n,e)};const o=document.getElementById(`${t}-btn`);o&&(o.onclick=()=>Ve(n,e))}document.getElementById("new-flags").onclick=e=>Ve("newPeakStyle",e.target),document.getElementById("enable-res").onclick=e=>Ve("showEnergyRes",e.target),document.getElementById("fwhm-fast").onclick=e=>Ve("useFWHMFast",e.target),document.getElementById("edit-plot").onclick=e=>Ve("editMode",e.target),document.getElementById("toggle-time-limit").onclick=e=>Ve("timeLimitBool",e.target),document.getElementById("download-format").onchange=e=>Ve("plotDownload",e.target),document.getElementById("theme-select").onchange=e=>Ve("theme",e.target)}();const t=document.getElementById("main-tabs").getElementsByTagName("button");for(const e of t)e.addEventListener("shown.bs.tab",(()=>{const e=document.getElementById("toggle-calibration-chart"),t=document.getElementById("toggle-evolution-chart");e.checked||t.checked?(e.checked=!1,t.checked=!1,ue(!1),he(!1)):r.updatePlot(s)}));const n=document.getElementById("table"),i=n.querySelectorAll("th[data-sort-by]");i.forEach((e=>{e.addEventListener("click",(()=>{const t=Number(e.dataset.sortBy),o=M[t];M.fill("none"),M[t]="asc"===o?"desc":"asc",i.forEach(((e,t)=>{const n=e.querySelector(".fa-solid");n.classList.remove(...Object.values(L)),n.classList.add(L[M[t+1]])})),Se(n,t,M[t])}))})),B?document.getElementById("notifications-toggle").disabled=!1:console.error("Browser does not support Notifications API."),function(){document.addEventListener("keydown",(e=>{if("escape"===e.key.toLowerCase()){const e=document.getElementById("offcanvas");e&&!e.classList.contains("show")&&(e.classList.contains("showing")||new window.bootstrap.Offcanvas(e).show())}}));const e=document.getElementById("toggle-menu");e&&(e.title+=" (ESC)");for(const[e,t]of Object.entries(D)){const n=document.getElementById(t);document.addEventListener("keydown",(t=>{t.altKey&&t.key.toLowerCase()===e.toLowerCase()&&(t.preventDefault(),t.repeat||n?.click())})),n&&(n.title+=` (ALT+${e.toUpperCase()})`)}}(),C&&We("autosave")&&Ie("autosave-dialog");const c=document.getElementById("loading");c.parentNode.removeChild(c)},window.onbeforeunload=e=>(e.preventDefault(),e.returnValue="Are you sure you want to exit?"),window.onpagehide=()=>{localStorage.removeItem("autosave")},document.body.onresize=()=>{r.updatePlot(s),navigator.userAgent.toLowerCase().match(/mobile|tablet|android|webos|iphone|ipad|ipod|blackberry|bb|playbook|iemobile|windows phone|kindle|silk|opera mini/i)||Y()},window.matchMedia("(display-mode: standalone)").addEventListener("change",(()=>{window.location.reload()})),window.addEventListener("beforeinstallprompt",(e=>{e.preventDefault(),P=e,C&&(We("installPrompt")||(Ie("pwa-installer"),Ue("installPrompt",!0))),document.getElementById("manual-install").classList.remove("d-none")})),document.getElementById("install-pwa-btn").onclick=()=>F(),document.getElementById("install-pwa-toast-btn").onclick=()=>F(),window.addEventListener("onappinstalled",(()=>{P=null,Be("pwa-installer"),document.getElementById("manual-install").classList.add("d-none")})),document.getElementById("notifications-toggle").onclick=e=>A(e.target.checked),document.getElementById("notifications-toast-btn").onclick=()=>A(!0),document.getElementById("data").onclick=e=>U(e,"data"),document.getElementById("background").onclick=e=>U(e,"background");const _=[{description:"Combination data file",accept:{"application/json":[".json"],"application/xml":[".xml"]}},{description:"Single spectrum file",accept:{"text/csv":[".csv"],"text/txt":[".txt"],"text/TKA":[".TKA"]}}];let R,H,$;async function U(e,t){if(window.FileSystemHandle&&window.showOpenFilePicker){e.preventDefault();const n={types:_,multiple:!1};let o;try{[o]=await window.showOpenFilePicker(n)}catch(e){return void console.warn("File Picker error:",e)}const a=await o.getFile();V(a,t);const i=a.name.split(".")[1].toLowerCase();if("json"!==i&&"xml"!==i)return;"background"===t?H=o:R=o,T&&O(o.name)}}function W(e,t){e.files?.length&&V(e.files[0],t)}function V(e,t){const n=new FileReader,o=e.name.split(".")[1];n.readAsText(e),n.onerror=()=>{new a.ToastNotification("fileError")},n.onload=async()=>{const i=n.result.trim();if("xml"===o.toLowerCase()){if(!window.DOMParser)return console.error("No DOM parser in this browser!"),void(document.getElementById("overwrite-button").disabled=!0);{const{espectrum:e,bgspectrum:n,coeff:o,meta:c}=l.xmlToArray(i);if(document.getElementById("sample-name").value=c.name,document.getElementById("sample-loc").value=c.location,c.time){const e=new Date(c.time),t=new Date(e.getTime()-60*e.getTimezoneOffset()*1e3);document.getElementById("sample-time").value=t.toISOString().slice(0,16)}if(document.getElementById("sample-vol").value=c.volume?.toString()??"",document.getElementById("sample-weight").value=c.weight?.toString()??"",document.getElementById("device-name").value=c.deviceName,document.getElementById("add-notes").value=c.notes,De=new Date(c.startTime),Pe=new Date(c.endTime),e?.length&&n?.length)s.data=e,s.background=n,s.dataTime=1e3*c.dataMt,s.backgroundTime=1e3*c.backgroundMt,c.dataMt&&(s.dataCps=s.data.map((e=>e/c.dataMt))),c.backgroundMt&&(s.backgroundCps=s.background.map((e=>e/c.backgroundMt))),t="both";else if(e?.length||n?.length){if("both"!==t){const o=e?.length?e:n,a=1e3*(e?.length?c.dataMt:c.backgroundMt),i=t;s[i]=o,s[`${i}Time`]=a,a&&(s[`${i}Cps`]=s[i].map((e=>e/a*1e3)))}}else new a.ToastNotification("fileError");if(Object.values(o).filter((e=>0!==e)).length>=2){de(),r.calibration.coeff=o,r.calibration.imported=!0,ce();const e=document.getElementsByClassName("cal-setting");for(const t of e)t.disabled=!0;G(),le(!0)}}}else{if("json"===o.toLowerCase()){const n=await l.jsonToObject(i);if(n.length>1){const o=document.getElementById("file-select-modal"),a=new window.bootstrap.Modal(o),i=document.getElementById("select-spectrum");i.options.length=0;for(const o of n){if(j(e.name,o))return;const n=document.createElement("option"),a={filename:e.name,package:o,type:t};n.value=JSON.stringify(a),n.text=`${o.sampleInfo?.name} (${o.resultData.startTime??"Undefined Time"})`,i.add(n)}a.show()}else{const o=n[0];if(j(e.name,o))return void(document.getElementById("overwrite-button").disabled=!0);z(e.name,o,t)}return}if("background"===t||"data"===t){s[`${t}Time`]=1e3;const e=l.csvToArray(i);if(s[t]=e.histogramData,e.calibrationCoefficients){de();for(const t in e.calibrationCoefficients)r.calibration.coeff[`c${parseInt(t)+1}`]=e.calibrationCoefficients[t];r.calibration.imported=!0,ce();const t=document.getElementsByClassName("cal-setting");for(const e of t)e.disabled=!0;G(),le(!0)}}else console.error("Could not import file, some kind of critical mistake happened. This is very bad and should not have happened!")}J(e.name,t)}}function j(e,t){if("code"in t&&"description"in t){const n=document.getElementById("import-error-modal"),o=new window.bootstrap.Modal(n);return document.getElementById("error-filename").innerText=e,document.getElementById("error-code").innerText=t.code,document.getElementById("error-desc").innerText=t.description,o.show(),!0}return!1}function z(e,t,n){if(document.getElementById("device-name").value=t?.deviceData?.deviceName??"",document.getElementById("sample-name").value=t?.sampleInfo?.name??"",document.getElementById("sample-loc").value=t?.sampleInfo?.location??"",t.sampleInfo?.time){const e=new Date(t.sampleInfo.time),n=new Date(e.getTime()-60*e.getTimezoneOffset()*1e3);document.getElementById("sample-time").value=n.toISOString().slice(0,16)}document.getElementById("sample-weight").value=t.sampleInfo?.weight?.toString()??"",document.getElementById("sample-vol").value=t.sampleInfo?.volume?.toString()??"",document.getElementById("add-notes").value=t.sampleInfo?.note??"";const o=t.resultData;o.startTime&&o.endTime&&(De=new Date(o.startTime),Pe=new Date(o.endTime));const a=o.energySpectrum,i=o.backgroundEnergySpectrum;if(a&&i){s.data=a.spectrum,s.background=i.spectrum;const e=a.measurementTime;e&&(s.dataTime=1e3*e,s.dataCps=s.data.map((t=>t/e)));const t=i.measurementTime;t&&(s.backgroundTime=1e3*t,s.backgroundCps=s.background.map((e=>e/t))),n="both"}else if("both"!==n){const e=a??i,t=e?.spectrum??[],o=1e3*(e?.measurementTime??1),r=n;s[r]=t,s[`${r}Time`]=o,o&&(s[`${r}Cps`]=s[r].map((e=>e/o*1e3)))}const l=(a??i)?.energyCalibration;if(l){const e=l.coefficients,t=l.polynomialOrder;de();for(const n in e)r.calibration.coeff["c"+(t-parseInt(n)+1)]=e[n];r.calibration.imported=!0,ce();const n=document.getElementsByClassName("cal-setting");for(const e of n)e.disabled=!0;G(),le(!0)}J(e,n)}function J(e,t){"both"===t?(document.getElementById("data-form-label").innerText=e,document.getElementById("background-form-label").innerText=e):document.getElementById(`${t}-form-label`).innerText=e,Z(),K(),s.background.length!==s.data.length&&s.data.length&&s.background.length&&(new a.ToastNotification("dataError"),X(t)),r.resetPlot(s),oe()}async function q(e){const t=We("autosave");if(t&&(localStorage.removeItem("autosave"),e)){const e=await l.jsonToObject(t);e.length?z("Autosave Data",e[0],"data"):console.error("Could not load autosaved data!")}}function Y(){(document.documentElement.clientWidth<=1100||document.documentElement.clientHeight<=700)&&console.warn("Small screen detected. Screen should be at least 1100x700 px for the best experience.")}function X(e){let t;t="both"===e?["data","background"]:[e];for(const e of t)s[e]=[],s[`${e}Time`]=0,document.getElementById(e).value="",document.getElementById(`${e}-form-label`).innerText="No File Chosen","data"===e&&(R=void 0),"background"===e&&(H=void 0),R?O(R.name):H?O(H.name):document.getElementById("overwrite-button").disabled=!0,document.getElementById(e+"-icon").classList.add("d-none");Z(),K(),r.resetPlot(s),oe()}function G(){document.getElementById("calibration-title").classList.remove("d-none")}function Z(){const e=s.getTotalCounts("data"),t=s.getTotalCounts("background");document.getElementById("total-spec-cts").innerText=e.toString(),document.getElementById("total-bg-cts").innerText=t.toString(),e&&document.getElementById("data-icon").classList.remove("d-none"),t&&document.getElementById("background-icon").classList.remove("d-none")}function K(){document.getElementById("spec-time").innerText=st(s.dataTime),document.getElementById("bg-time").innerText=st(s.backgroundTime)}function Q(e){l.fileType=parseInt(e.value),l.valueIndex=parseInt(e.value),Ue("fileDataMode",e.id)}function ee(e=!0){e&&("log"===r.xAxis&&te(document.getElementById("xAxis")),"log"===r.yAxis&&te(document.getElementById("yAxis")),r.sma&&ne(!1,document.getElementById("sma"))),r.clearAnnos(),document.getElementById("check-all-isos").checked=!1,Oe(!0),r.resetPlot(s),oe()}function te(e){const t=e.id;"linear"===r[t]?(r[t]="log",e.innerText="Log",r.resetPlot(s),oe()):(r[t]="linear",e.innerText="Linear",r.updatePlot(s))}function ne(e,t=null){r.sma=e,t&&(t.checked=!1),r.updatePlot(s)}function oe(){if(!r.plotDiv)return;const e=r.plotDiv;e.on("plotly_hover",ae),e.on("plotly_unhover",ie),e.on("plotly_click",se),e.on("plotly_selected",re),e.addEventListener("contextmenu",(e=>{e.preventDefault()}))}function ae(e){for(const t in c){const n=t;c[n]&&(document.getElementById(`adc-${n}`).value=e.points[0].x.toFixed(2))}E&&_e(e.points[0].x)}function ie(){for(const e in c){const t=e;c[t]&&(document.getElementById(`adc-${t}`).value=d[t])}}function se(e){document.getElementById("click-data").innerText=e.points[0].x.toFixed(2)+e.points[0].xaxis.ticksuffix+": "+e.points[0].y.toFixed(2)+e.points[0].yaxis.ticksuffix;for(const t in c){const n=t;c[n]&&(document.getElementById(`adc-${n}`).value=e.points[0].x.toFixed(2),d[n]=e.points[0].x.toFixed(2),c[n]=!1,document.getElementById(`select-${n}`).checked=c[t])}if($&&r.toggleLine($,$.toString(),!1),0===e.event.button){const t=Math.round(e.points[0].x);r.toggleLine(t,t.toString(),!0),$=t}else 2===e.event.button&&($=void 0);r.updatePlot(s)}function re(e){const t=document.getElementById("roi-info"),n=document.getElementById("static-info");if(!e?.range?.x.length)return t.classList.add("d-none"),void n.classList.remove("d-none");t.classList.remove("d-none"),n.classList.add("d-none");let o=e.range.x;o=o.map((e=>Math.round(e)));let a=o[0],i=o[1];if(document.getElementById("roi-range").innerText=`${a.toString()} - ${i.toString()}`,document.getElementById("roi-range-unit").innerText=r.calibration.enabled?" keV":"",r.calibration.enabled){const e=Math.max(s.data.length,s.background.length),t=r.getCalAxis(e),n=t.length,o=[a,i],l=o.length,c=[];let d=0;for(let e=0;e<n&&!(t[e]>o[d]&&(c.push(e),d++,d>=l));e++);a=c[0],i=c[1]}const l=s.getTotalCounts("data",a,i),c=s.getTotalCounts("background",a,i),d=l-c;document.getElementById("total-counts").innerText=l.toString(),document.getElementById("net-counts").innerText=d.toString(),document.getElementById("bg-counts").innerText=c.toString(),document.getElementById("bg-ratio").innerText=(d/c*100).toFixed()}async function le(e){if(document.getElementById("calibration-label").innerHTML=e?'<i class="fa-solid fa-rotate-left"></i> Reset':'<i class="fa-solid fa-check"></i> Calibrate',document.getElementById("apply-cal").checked=e,e&&!r.calibration.imported){const e=[[document.getElementById("adc-a").value,document.getElementById("cal-a").value],[document.getElementById("adc-b").value,document.getElementById("cal-b").value],[document.getElementById("adc-c").value,document.getElementById("cal-c").value]];let t=0;const n=[];for(const o of e){const e=parseFloat(o[0]),i=parseFloat(o[1]);if(isNaN(e)||isNaN(i)?t+=1:n.push([e,i]),t>1){new a.ToastNotification("calibrationApplyError");const e=document.getElementById("apply-cal");return e.checked=!1,void le(e.checked)}}r.calibration.points.aFrom=n[0][0],r.calibration.points.aTo=n[0][1],r.calibration.points.bFrom=n[1][0],r.calibration.points.bTo=n[1][1],3===n.length?(r.calibration.points.cTo=n[2][1],r.calibration.points.cFrom=n[2][0]):(delete r.calibration.points.cTo,delete r.calibration.points.cFrom),await r.computeCoefficients()}ce(),r.calibration.enabled=e,r.resetPlot(s),oe()}function ce(){const e=["c1","c2","c3"];for(const t of e)document.getElementById(`${t}-coeff`).innerText=r.calibration.coeff[t].toString()}function de(){for(const e in c)c[e]=!1;const e=document.getElementsByClassName("cal-setting");for(const t of e)t.disabled=!1,t.value="";document.getElementById("calibration-title").classList.add("d-none"),r.clearCalibration(),le(!1)}function me(e,t){c[e]=t}function ue(e){document.getElementById("toggle-cal-chart-label").innerHTML=e?'<i class="fa-solid fa-eye-slash fa-beat-fade"></i> Hide Chart':'<i class="fa-solid fa-eye"></i> Show Chart',r.setChartType(e?"calibration":"default",s),e||oe()}function he(e){document.getElementById("toggle-evol-chart-label").innerHTML=e?'<i class="fa-solid fa-eye-slash fa-beat-fade"></i> Hide Evolution':'<i class="fa-solid fa-eye"></i> Show Evolution',r.setChartType(e?"evolution":"default",s,b),e||oe()}function ge(e){return parseFloat(e)<10?"0"+e:e}function pe(){const e=new Date;return e.getFullYear()+"-"+ge((e.getMonth()+1).toString())+"-"+ge(e.getDate().toString())+"_"+ge(e.getHours().toString())+"-"+ge(e.getMinutes().toString())}function fe(){const e=new Date;return e.getFullYear()+"-"+ge((e.getMonth()+1).toString())+"-"+ge(e.getDate().toString())}function ye(e){let t=e.getFullYear()+"-"+ge((e.getMonth()+1).toString())+"-"+ge(e.getDate().toString())+"T"+ge(e.getHours().toString())+":"+ge(e.getMinutes().toString())+":"+ge(e.getSeconds().toString());t+=-e.getTimezoneOffset()<0?"-":"+";const n=new Date(Math.abs(e.getTimezoneOffset()));return t+=ge(n.getHours().toString())+":"+ge(n.getMinutes().toString()),t}function be(e,t){const n=document.createElementNS(null,"data"===e?"EnergySpectrum":"BackgroundEnergySpectrum"),o=document.createElementNS(null,"NumberOfChannels");o.textContent=s[e].length.toString(),n.appendChild(o);const a=document.createElementNS(null,"SpectrumName");if(a.textContent=t,n.appendChild(a),r.calibration.enabled){const e=document.createElementNS(null,"EnergyCalibration");n.appendChild(e);const t=document.createElementNS(null,"Coefficients"),o=[],a=r.calibration.coeff;for(const e in a)o.push(a[e]);const i=o.reverse();for(const e of i){const n=document.createElementNS(null,"Coefficient");n.textContent=e.toString(),t.appendChild(n)}e.appendChild(t);const s=document.createElementNS(null,"PolynomialOrder");s.textContent=2..toString(),e.appendChild(s)}const i=document.createElementNS(null,"TotalPulseCount");i.textContent=s.getTotalCounts(e).toString(),n.appendChild(i);const l=document.createElementNS(null,"ValidPulseCount");l.textContent=i.textContent,n.appendChild(l);const c=document.createElementNS(null,"MeasurementTime");c.textContent=Math.round(s[`${e}Time`]/1e3).toString(),n.appendChild(c);const d=document.createElementNS(null,"Spectrum");n.appendChild(d);const m=s[e];for(const e of m){const t=document.createElementNS(null,"DataPoint");t.textContent=e.toString(),d.appendChild(t)}return n}function we(){const e=fe()+" Energy Spectrum",t=fe()+" Background Energy Spectrum",n=document.implementation.createDocument(null,"ResultDataFile"),o=n.createProcessingInstruction("xml",'version="1.0" encoding="UTF-8"');n.insertBefore(o,n.firstChild);const a=n.documentElement,i=document.createElementNS(null,"FormatVersion");i.textContent=230124..toString(),a.appendChild(i);const r=document.createElementNS(null,"ResultDataList");a.appendChild(r);const l=document.createElementNS(null,"ResultData");r.appendChild(l);const c=document.createElementNS(null,"DeviceConfigReference");l.appendChild(c);const d=document.createElementNS(null,"Name");if(d.textContent=document.getElementById("device-name").value.trim(),c.appendChild(d),De){const e=document.createElementNS(null,"StartTime");e.textContent=ye(De),l.appendChild(e);const t=document.createElementNS(null,"EndTime");l.appendChild(t),Pe&&Pe.getTime()-De.getTime()>=0?t.textContent=ye(Pe):t.textContent=ye(new Date)}const m=document.createElementNS(null,"SampleInfo");l.appendChild(m);const u=document.createElementNS(null,"Name");u.textContent=document.getElementById("sample-name").value.trim(),m.appendChild(u);const h=document.createElementNS(null,"Location");h.textContent=document.getElementById("sample-loc").value.trim(),m.appendChild(h);const g=document.createElementNS(null,"Time"),p=document.getElementById("sample-time").value.trim();p.length&&(g.textContent=ye(new Date(p)),m.appendChild(g));const f=document.createElementNS(null,"Weight"),y=document.getElementById("sample-weight").value.trim();y.length&&(f.textContent=(parseFloat(y)/1e3).toString(),m.appendChild(f));const b=document.createElementNS(null,"Volume"),w=document.getElementById("sample-vol").value.trim();w.length&&(b.textContent=(parseFloat(w)/1e3).toString(),m.appendChild(b));const k=document.createElementNS(null,"Note");if(k.textContent=document.getElementById("add-notes").value.trim(),m.appendChild(k),s.data.length&&l.appendChild(be("data",e)),s.background.length){const e=document.createElementNS(null,"BackgroundSpectrumFile");e.textContent=t,l.appendChild(e),l.appendChild(be("background",t))}const E=document.createElementNS(null,"Visible");return E.textContent=(!0).toString(),l.appendChild(E),(new XMLSerializer).serializeToString(n)}function ke(e){const t={numberOfChannels:s[e].length,validPulseCount:s.getTotalCounts(e),measurementTime:0,spectrum:s[e]};if(t.measurementTime=Math.round(s[`${e}Time`]/1e3),r.calibration.enabled){const e={polynomialOrder:2,coefficients:[]};e.coefficients=[r.calibration.coeff.c3,r.calibration.coeff.c2,r.calibration.coeff.c1],t.energyCalibration=e}return t}function Ee(){const e={schemaVersion:"NPESv2",data:[]},t={deviceData:{softwareName:"Gamma MCA, "+x,deviceName:document.getElementById("device-name").value.trim()},sampleInfo:{name:document.getElementById("sample-name").value.trim(),location:document.getElementById("sample-loc").value.trim(),note:document.getElementById("add-notes").value.trim()},resultData:{}};let n=parseFloat(document.getElementById("sample-weight").value.trim());n&&(t.sampleInfo.weight=n),n=parseFloat(document.getElementById("sample-vol").value.trim()),n&&(t.sampleInfo.volume=n);const o=document.getElementById("sample-time").value.trim();if(o.length&&new Date(o)&&(t.sampleInfo.time=ye(new Date(o))),De&&(t.resultData.startTime=ye(De),Pe&&Pe.getTime()-De.getTime()>=0?t.resultData.endTime=ye(Pe):t.resultData.endTime=ye(new Date)),s.data.length&&s.getTotalCounts("data")&&(t.resultData.energySpectrum=ke("data")),s.background.length&&s.getTotalCounts("background")&&(t.resultData.backgroundEnergySpectrum=ke("background")),t.resultData.energySpectrum||t.resultData.backgroundEnergySpectrum)return e.data.push(t),JSON.stringify(e)}function ve(e,t){e+=`_${pe()}.csv`;let n="";s[t].forEach((e=>n+=e+"\n")),Ce(e,n,"CSV")}document.getElementById("data").onchange=e=>W(e.target,"data"),document.getElementById("background").onchange=e=>W(e.target,"background"),document.getElementById("spectrum-select-btn").onclick=()=>function(){const e=JSON.parse(document.getElementById("select-spectrum").value);z(e.filename,e.package,e.type);document.getElementById("file-select-modal").querySelector(".btn-close").click()}(),document.getElementById("restore-data-btn").onclick=()=>q(!0),document.getElementById("discard-data-btn").onclick=()=>q(!1),document.getElementById("clear-data").onclick=()=>X("data"),document.getElementById("clear-bg").onclick=()=>X("background"),document.getElementById("r1").onchange=e=>Q(e.target),document.getElementById("r2").onchange=e=>Q(e.target),document.getElementById("reset-plot").onclick=()=>ee(),document.getElementById("xAxis").onclick=e=>te(e.target),document.getElementById("yAxis").onclick=e=>te(e.target),document.getElementById("sma").onclick=e=>ne(e.target.checked),document.getElementById("sma-val").onkeydown=e=>{"Enter"===e.key&&document.getElementById("sma")?.click()},document.getElementById("sma-val").oninput=e=>function(e){const t=parseInt(e.value);isNaN(t)?new a.ToastNotification("smaError"):(r.smaLength=t,r.updatePlot(s),Ue("smaLength",t))}(e.target),document.getElementById("apply-cal").onclick=e=>le(e.target.checked),document.getElementById("calibration-reset").onclick=()=>de(),document.getElementById("select-a").onclick=e=>me("a",e.target.checked),document.getElementById("select-b").onclick=e=>me("b",e.target.checked),document.getElementById("select-c").onclick=e=>me("c",e.target.checked),document.getElementById("plot-type").onclick=()=>function(){const e=document.getElementById("plot-type");r.linePlot?e.innerHTML='<i class="fas fa-chart-bar"></i> Bar':e.innerHTML='<i class="fas fa-chart-line"></i> Line',r.linePlot=!r.linePlot,r.updatePlot(s)}(),document.getElementById("plot-cps").onclick=e=>{return t=e.target,r.cps=!r.cps,t.innerText=r.cps?"CPS":"Total",void r.updatePlot(s);var t},document.getElementById("cal-input").onchange=e=>{return t=e.target,void(t.files?.length&&function(e){const t=new FileReader;t.readAsText(e),t.onload=()=>{try{const e=t.result.trim(),n=JSON.parse(e),o=[document.getElementById("adc-a"),document.getElementById("cal-a"),document.getElementById("adc-b"),document.getElementById("cal-b"),document.getElementById("adc-c"),document.getElementById("cal-c")];if(n.imported){const e=document.getElementsByClassName("cal-setting");for(const t of e)t.disabled=!0;G(),r.calibration.coeff=n.coeff,r.calibration.imported=!0}else{const e=["aFrom","aTo","bFrom","bTo","cFrom","cTo"];for(const t in e)void 0===n.points||"number"==typeof n.points?o[t].value=n[e[t]]:o[t].value=n.points[e[t]];d.a=o[0].value,d.b=o[2].value,d.c=o[4].value}}catch(e){console.error("Calibration Import Error:",e),new a.ToastNotification("calibrationImportError")}},t.onerror=()=>{new a.ToastNotification("fileError")}}(t.files[0]));var t},document.getElementById("toggle-calibration-chart").onclick=e=>ue(e.target.checked),document.getElementById("toggle-evolution-chart").onclick=e=>he(e.target.checked),document.getElementById("evolution-download-btn").onclick=()=>(b.length||console.error("Time evolution is empty. No cps values to export!"),void Ce(`evolution_${pe()}.csv`,b.join("\n"),"EVOL")),document.getElementById("calibration-download").onclick=()=>function(){const e=r.calibration;let t=JSON.stringify(e);0===e.coeff.c2&&0===e.coeff.c3&&(t=""),e.points.cFrom||delete e.points.cFrom,e.points.cTo||delete e.points.cTo,Ce(`calibration_${pe()}.json`,t,"CAL")}(),document.getElementById("xml-export-btn").onclick=()=>{Ce(`spectrum_${pe()}.xml`,we(),"XML")},document.getElementById("npes-export-btn").onclick=()=>{Ce(`spectrum_${pe()}.json`,Ee(),"JSON")},document.getElementById("download-spectrum-btn").onclick=()=>ve("spectrum","data"),document.getElementById("download-bg-btn").onclick=()=>ve("background","background"),document.getElementById("overwrite-button").onclick=()=>async function(){if(R&&H)return void new a.ToastNotification("saveMultipleAtOnce");if(!R&&!H)return void console.error("No file handlers found to save to!");const e=R??H,t=await e.createWritable();let n;n="xml"===(await e.getFile()).name.split(".")[1].toLowerCase()?we():Ee(),n?.trim()?(await t.write(n),await t.close(),new a.ToastNotification("saveFile")):new a.ToastNotification("fileEmptyError")}();const xe={CAL:{description:"Calibration data file",accept:{"application/json":[".json"]}},XML:{description:"Combination data file (XML)",accept:{"application/xml":[".xml"]}},JSON:{description:"Combination data file (NPESv2, smaller size)",accept:{"application/json":[".json"]}},EVOL:{description:"Count rate time evolution file",accept:{"text/csv":[".csv"]}},CSV:{description:"Single spectrum file",accept:{"text/csv":[".csv"]}}};async function Ce(e,t,n){if(t?.trim()){if(window.FileSystemHandle&&window.showSaveFilePicker){const o={suggestedName:e,types:[xe[n]]};let i;try{i=await window.showSaveFilePicker(o)}catch(e){return void console.warn("File SaveAs error:",e)}R?R=i:H&&(H=i);const s=await i.createWritable();await s.write(t),await s.close(),new a.ToastNotification("saveFile")}else{const n=document.createElement("a");n.setAttribute("href",`data:text/plain;charset=utf-8,${encodeURIComponent(t)}`),n.setAttribute("download",e),n.style.display="none",n.click()}localStorage.removeItem("autosave"),document.getElementById("export-modal").querySelector(".btn-close").click()}else new a.ToastNotification("fileEmptyError")}function Ie(e){const t=new window.bootstrap.Toast(document.getElementById(e));t.isShown()||t.show()}function Be(e){const t=new window.bootstrap.Toast(document.getElementById(e));t.isShown()&&t.hide()}function Se(e,t,n){const o=e.tBodies[0],a=Array.from(o.rows);a.sort(((e,o)=>{const a=e.cells[t].textContent?.trim()??"",i=o.cells[t].textContent?.trim()??"",s=parseFloat(a.replace(/[^\d.-]/g,"")),r=parseFloat(i.replace(/[^\d.-]/g,""));if(isNaN(s)||isNaN(r))return a.localeCompare(i);const l=s-r;return"asc"===n?l:-l})),o.append(...a)}document.getElementById("reset-meta-values").onclick=()=>function(){const e=document.getElementsByClassName("sample-info");for(const t of e)t.value=""}(),document.getElementById("print-report").onclick=()=>function(){const t=r.peakConfig.enabled;t||$e(document.getElementById("peak-finder-btn"));const n=r.computePulseHeightData(s),o=Ee();if(t||He(document.getElementById("peak-finder-btn")),!n.length||!o)return console.error("Nothing to analyze, no data found. Cannot print report!"),void new a.ToastNotification("reportError");const i=window.open("/print.html","_blank");i?(i.onload=()=>{const t=i.document,a=JSON.parse(o).data[0];t.getElementById("sample-name").innerText=a.sampleInfo?.name||"N/A",t.getElementById("sample-loc").innerText=a.sampleInfo?.location||"N/A",t.getElementById("sample-time").innerText=a.sampleInfo?.time||"N/A",t.getElementById("note").innerText=a.sampleInfo?.note||"N/A",t.getElementById("device-name").innerText=a.deviceData?.deviceName||"N/A",t.getElementById("software-name").innerText=a.deviceData?.softwareName||"N/A",t.getElementById("start-time").innerText=a.resultData.startTime??"N/A",t.getElementById("end-time").innerText=a.resultData.endTime??"N/A",t.getElementById("total-time-gross").innerText=a.resultData.energySpectrum?.measurementTime?.toString()||"N/A",t.getElementById("total-time-bg").innerText=a.resultData.backgroundEnergySpectrum?.measurementTime?.toString()||"N/A",t.getElementById("cal-coeffs").innerText=JSON.stringify(r.calibration.enabled?r.calibration.coeff:{c1:0,c2:0,c3:0})||"N/A";const s=t.getElementById("peak-table-head-row"),l=document.createElement("th");l.innerHTML="Peak Number <br>[1]",s.appendChild(l);const c=document.createElement("th");c.innerHTML=`Energy <br>[${r.calibration.enabled?"keV":"bin"}]`,s.appendChild(c);const d=document.createElement("th");d.innerHTML="Net Peak Area <br>(3&sigma;) [cts]",s.appendChild(d);const m=document.createElement("th");m.innerHTML="Background Peak Area <br>(3&sigma;) [cts]",s.appendChild(m);const u=document.createElement("th");u.innerHTML=`FWHM <br>[${r.calibration.enabled?"keV":"bin"}]`,s.appendChild(u);const h=document.createElement("th");h.innerHTML="FWHM <br>[%]",s.appendChild(h);const g=document.createElement("th");g.innerHTML="Net Peak Counts/s <br>(3&sigma;) [cps]",s.appendChild(g);const p=t.getElementById("peak-table-body"),f=n[0].x,y=n[0].y,b=r.peakFinder(y);let w=1;for(const t of b){const o=f[Math.round(t)];if(o<0)continue;const i=new e.CalculateFWHM([o],n[1].x,n[1].y).compute()[o],s=new e.CalculateFWHM([o],n[1].x,n[1].y).getResolution()[o],l=2*i/(2*Math.sqrt(2*Math.LN2)),c=o-l,d=o+l;let m=0,u=0;for(const e in f){const t=f[e];t>=c&&t<=d&&(m+=n[1].y[e],n.length>2&&(u+=n[2].y[e]))}const h=p.insertRow(),g=document.createElement("th");g.innerText=w.toString(),h.appendChild(g),h.insertCell().innerText=o.toFixed(2),h.insertCell().innerText=i>0&&i<.9*e.CalculateFWHM.resolutionLimit*o?(m*(r.cps?a.resultData.energySpectrum?.measurementTime??1:1)).toFixed(0):"N/A",h.insertCell().innerText=i>0&&i<.9*e.CalculateFWHM.resolutionLimit*o?(u*(r.cps?a.resultData.backgroundEnergySpectrum?.measurementTime??1:1)).toFixed(0):"N/A",h.insertCell().innerText=i>0&&i<.9*e.CalculateFWHM.resolutionLimit*o?i.toFixed(3):"OVF",h.insertCell().innerText=s>0&&s<.9*e.CalculateFWHM.resolutionLimit?(100*s).toFixed(2):"OVF",h.insertCell().innerText=i>0&&i<.9*e.CalculateFWHM.resolutionLimit*o?(r.cps?m:m/(a.resultData.energySpectrum?.measurementTime??1)).toExponential(3):"N/A",w++}window.Plotly.toImage(r.plotDiv,{format:"png",height:400,width:1e3}).then((function(e){const n=t.getElementById("plot-image");n.src=e,n.onload=()=>i.print()}))},i.onafterprint=()=>i.close()):console.error("Unable to open a new window for printing.")}(),document.getElementById("toggle-menu").onclick=()=>Oe(),document.getElementById("reload-isos-btn").onclick=()=>Oe(!0);let Te,Ne,Me,Le,De,Pe,Fe,Ae=!1;async function Oe(t=!1){if(Ae&&!t)return!0;const n=document.getElementById("iso-loading");n.classList.remove("d-none");const o={cache:"no-cache",headers:{"Content-Type":"text/plain; application/json; charset=UTF-8"}},a=document.getElementById("iso-load-error");a.classList.add("d-none");let i=!0;try{const t=await fetch(w,o);if(t.ok){const n=await t.json();Ae=!0;const o=document.getElementById("table"),a=o.querySelector("#iso-table");a.innerHTML="";for(const[e,t]of Object.entries(n)){let n=0;const o=e.toLowerCase().replace(/[^a-z0-9 -]/gi,"").trim(),i=o.charAt(0).toUpperCase()+o.slice(1);for(const e of t){if(isNaN(e))continue;k[i]?k[i].push(e):k[i]=[e];const t=i+"-"+n;n++;const o=a.insertRow(),s=o.insertCell(0),r=o.insertCell(1),l=o.insertCell(2);s.onclick=()=>s.firstChild.click(),r.onclick=()=>s.firstChild.click(),l.onclick=()=>s.firstChild.click(),s.style.cursor="pointer",r.style.cursor="pointer",l.style.cursor="pointer",s.innerHTML=`<input class="form-check-input iso-table-label" id="${t}" type="checkbox" value="${e}">`,l.innerText=e.toFixed(2);const c=document.getElementById(t);c.onclick=()=>Re(c);const d=i.split("-");r.innerHTML=`<sup>${d[1]}</sup>${d[0]}`}}"asc"!==M[2]?o.querySelector('th[data-sort-by="2"]').click():Se(o,2,"asc"),r.clearAnnos(),r.updatePlot(s),r.isotopeSeeker=new e.SeekClosest(k),Ne=new e.SeekClosest(k)}else a.innerText=`Could not load isotope list! HTTP Error: ${t.status}. Please try again.`,a.classList.remove("d-none"),i=!1}catch(e){console.error(e),a.innerText="Could not load isotope list! Connection refused - you are probably offline.",a.classList.remove("d-none"),i=!1}return n.classList.add("d-none"),i}async function _e(t){if(!await Oe())return;Ne||(Ne=new e.SeekClosest(k)),Te&&r.toggleLine(Te[1],Te[0],!1);const{energy:n,name:o}=Ne.seek(t,v);if(n&&o){const e=[o,n];Te!==e&&(Te=e),r.toggleLine(n,o)}r.updatePlot(s)}function Re(e){const t=e.id.split("-");r.toggleLine(parseFloat(e.value),t[0]+"-"+t[1],e.checked),r.updatePlot(s)}function He(e){r.clearPeakFinder(),r.peakConfig.enabled=!1,e.innerText="None"}function $e(e){r.peakConfig.enabled=!0,r.peakConfig.mode="gaussian",e.innerText="Gaussian"}function Ue(e,t){return!!C&&(localStorage.setItem(e,JSON.stringify(t)),!0)}function We(e){return JSON.parse(localStorage.getItem(e))}function Ve(t,n){const c=n.value.trim();let d=!1;if(n.checkValidity()&&c){switch(t){case"editMode":{const e=n.checked;r.editableMode=e,r.resetPlot(s),oe(),d=Ue(t,e);break}case"customURL":try{w=new URL(c).href,Oe(!0),d=Ue(t,w)}catch(e){new a.ToastNotification("settingError"),console.error("Custom URL Error",e)}break;case"fileDelimiter":l.delimiter=c,d=Ue(t,c);break;case"fileChannels":{const e=parseInt(c);l.adcChannels=e,d=Ue(t,e);break}case"timeLimitBool":{const e=n.checked;h=e,d=Ue(t,e);break}case"timeLimit":{const e=n.id.split("-"),o=["s","m","h"];let a=0;for(const t in o)a+=parseInt(document.getElementById(`${e[0]}-${e[1]}-${o[t]}`).value.trim())*60**parseInt(t);a*=1e3,g=a,d=Ue(t,g);break}case"maxIsoDist":{const e=parseFloat(c);v=e,d=Ue(t,v);break}case"plotRefreshRate":{const e=parseFloat(c);u=1e3*e,d=Ue(t,u);break}case"serBufferSize":{const e=parseInt(c);o.SerialManager.maxSize=e,d=Ue(t,o.SerialManager.maxSize);break}case"baudRate":{const e=parseInt(c);o.SerialManager.baudRate=e,d=Ue(t,o.SerialManager.baudRate);break}case"eolChar":o.SerialManager.eolChar=c,d=Ue(t,c);break;case"serChannels":{const e=parseInt(c);o.SerialManager.adcChannels=e,d=Ue(t,e);break}case"peakThres":{const e=parseFloat(c);r.peakConfig.thres=e,r.updatePlot(s),d=Ue(t,e);break}case"peakLag":{const e=parseInt(c);r.peakConfig.lag=e,r.updatePlot(s),d=Ue(t,e);break}case"seekWidth":{const n=parseFloat(c);e.SeekClosest.seekWidth=n,r.updatePlot(s),d=Ue(t,n);break}case"plotDownload":r.downloadFormat=c,r.updatePlot(s),d=Ue(t,c);break;case"theme":d=Ue(t,c),r.darkMode="dark"===(0,i.applyTheming)(),ee(!1);break;case"gaussSigma":{const e=parseInt(c);r.gaussSigma=e,r.updatePlot(s),d=Ue(t,e);break}case"showEnergyRes":{const e=n.checked;r.peakConfig.showFWHM=e,r.updatePlot(s),d=Ue(t,e);break}case"useFWHMFast":{const o=n.checked;e.CalculateFWHM.fastMode=o,r.updatePlot(s),d=Ue(t,o);break}case"newPeakStyle":{const e=n.checked;r.peakConfig.newPeakStyle=e,r.updatePlot(s),d=Ue(t,e);break}default:return void new a.ToastNotification("settingError")}d&&new a.ToastNotification("settingSuccess")}else new a.ToastNotification("settingType")}function je(e){o.SerialManager.orderType=e.value,Ue("serialDataMode",e.id)}function ze(){qe(),new a.ToastNotification("serialConnect")}function Je(e){Me?.isThisPort(e.target)&&Ge(!0),qe(),new a.ToastNotification("serialDisconnect")}async function qe(){const e=document.getElementById("port-selector");for(let t=e.options.length;t>=0;t--)e.remove(t);if(m=[],navigator.serial){const e=await navigator.serial.getPorts();for(const t of e)m.push(new o.WebSerial(t))}else if(navigator.usb){const e=await navigator.usb.getDevices();for(const t of e)m.push(new o.WebUSBSerial(t))}let t=0;for(const n in m){const o=document.createElement("option");o.text=`Port ${n} (${m[n]?.getInfo()})`,e.add(o,parseInt(n)),Me?.isThisPort(m[n]?.getPort())&&(t=parseInt(n),o.text="> "+o.text)}const n=document.getElementsByClassName("ser-settings");if(e.options.length){e.selectedIndex=t;for(const e of n)e.disabled=!1}else{const t=document.createElement("option");t.text="No Ports Available",e.add(t);for(const e of n)e.disabled=!0}}function Ye(){const e=document.getElementById("port-selector").selectedIndex,t=m[e];return t&&!Me?.isThisPort(t.getPort())&&(Me=new o.SerialManager(t),Ze()),e}async function Xe(e=!1,t){try{Ye(),await(Me?.startRecord(e))}catch(e){return console.error("Connection Error:",e),void new a.ToastNotification("serialConnectError")}if(I)try{Fe=await navigator.wakeLock.request("screen"),document.addEventListener("visibilitychange",(async()=>{null!==Fe&&"visible"===document.visibilityState&&(Fe=await navigator.wakeLock.request("screen"))}))}catch(e){console.error("Screen Wake Lock Error:",e)}Le=t,e||(X(t),document.getElementById(`${t}-form-label`).innerText="Serial Recording",De=new Date),document.getElementById("toggle-evolution-chart").disabled=!1,document.getElementById("stop-button").disabled=!1,document.getElementById("pause-button").classList.remove("d-none"),document.getElementById("record-button").classList.add("d-none"),document.getElementById("resume-button").classList.add("d-none");const n=document.getElementsByClassName("recording-spinner");for(const e of n)e.classList.remove("d-none");dt(t,!e),rt(t),it(),e?b.pop():b=[]}async function Ge(e=!1){document.getElementById("pause-button").classList.add("d-none");const t=document.getElementsByClassName("recording-spinner");for(const e of t)e.classList.add("d-none");document.getElementById("resume-button").classList.toggle("d-none",e),e&&(document.getElementById("stop-button").disabled=!0,document.getElementById("record-button").classList.remove("d-none"),Pe=new Date),Fe?.release().then((()=>{Fe=null}));try{clearTimeout(tt),clearTimeout(lt),clearTimeout(nt),clearTimeout(et)}catch(e){console.warn("No timeout to clear. Something might be wrong...",e)}try{await(Me?.stopRecord())}catch(e){console.error("Misc Serial Read Error:",e),new a.ToastNotification("miscSerialError"),(0,a.launchSysNotification)("Recording Crashed!","A fatal error occured with the connected serial device and the recording has stopped.")}}function Ze(){document.getElementById("ser-output").innerText="",Me?.flushRawData()}async function Ke(){try{const e=Ye();document.getElementById("serial-console-title").innerText=`(Port ${e})`,await(Me?.showConsole())}catch(e){return console.error("Connection Error:",e),void new a.ToastNotification("serialConnectError")}at()}document.getElementById("iso-hover").onclick=()=>(E=!E,void _e(-1e5)),document.getElementById("check-all-isos").onclick=e=>function(e){const t=document.getElementById("table").tBodies[0].rows;for(const n of t){const t=n.cells[0].firstChild;if(t.checked=e.checked,e.checked){const e=t.id.split("-");r.toggleLine(parseFloat(t.value),e[0]+"-"+e[1],t.checked)}}e.checked||r.clearAnnos(),r.updatePlot(s)}(e.target),document.getElementById("peak-finder-btn").onclick=e=>async function(e){if(r.peakConfig.enabled)switch(r.peakConfig.mode){case"gaussian":!function(e){r.peakConfig.mode="energy",e.innerText="Energy"}(e);break;case"energy":await async function(e){r.clearPeakFinder(),await Oe(),r.peakConfig.mode="isotopes",e.innerText="Isotopes"}(e);break;case"isotopes":He(e)}else $e(e);r.updatePlot(s)}(e.target),document.getElementById("reset-gamma-mca").onclick=()=>(C&&localStorage.clear(),void window.location.reload()),document.getElementById("s1").onchange=e=>je(e.target),document.getElementById("s2").onchange=e=>je(e.target),document.getElementById("serial-list-btn").onclick=()=>qe(),document.getElementById("serial-add-device").onclick=()=>async function(){try{navigator.serial?await navigator.serial.requestPort():await navigator.usb.requestDevice({filters:o.WebUSBSerial.deviceFilters}),qe()}catch(e){console.warn("Aborted adding a new port!",e)}}(),document.getElementById("resume-button").onclick=()=>Xe(!0,Le),document.getElementById("record-spectrum-btn").onclick=()=>Xe(!1,"data"),document.getElementById("record-bg-btn").onclick=()=>Xe(!1,"background"),document.getElementById("pause-button").onclick=()=>Ge(),document.getElementById("stop-button").onclick=()=>Ge(!0),document.getElementById("clear-console-log").onclick=()=>Ze(),document.getElementById("serial-console-modal").addEventListener("show.bs.modal",(()=>{Ke()})),document.getElementById("serial-console-modal").addEventListener("hide.bs.modal",(async()=>{await(Me?.hideConsole()),clearTimeout(et)})),document.getElementById("ser-command").onkeydown=e=>{"Enter"===e.key&&document.getElementById("send-command")?.click(),"ArrowUp"!==e.key&&"ArrowDown"!==e.key||(e.preventDefault(),function(e){const t=document.getElementById("ser-command");"ArrowUp"===e&&Qe.currentIndex<Qe.history.length-1?Qe.currentIndex++:"ArrowDown"===e&&Qe.currentIndex>-1&&Qe.currentIndex--,Qe.currentIndex>=0&&Qe.currentIndex<Qe.history.length?t.value=Qe.history[Qe.currentIndex]:t.value=""}(e.key))};const Qe={history:[],currentIndex:-1};document.getElementById("send-command").onclick=()=>async function(){const e=document.getElementById("ser-command");try{await(Me?.sendString(e.value))}catch(e){return console.error("Connection Error:",e),void new a.ToastNotification("serialConnectError")}const t=e.value.trim();t.length&&(Qe.history.unshift(t),Qe.currentIndex=-1),e.value=""}(),document.getElementById("reconnect-console-log").onclick=()=>async function(){await(Me?.hideConsole()),clearTimeout(et),Ke()}();let et,tt,nt,ot=!1;function at(){Me?.port?.isOpen&&(document.getElementById("ser-output").innerText=Me.getRawData(),et=setTimeout(at,f),ot&&document.getElementById("ser-output").scrollIntoView({behavior:"smooth",block:"end"}))}function it(){const e=document.getElementById("autosave-badge"),t=Ee();if(t&&Ue("autosave",t)){const t={month:"short",day:"numeric",hour:"numeric",minute:"numeric",hour12:!1},n=new Intl.DateTimeFormat("en-US",t).format(new Date);e.title=`The data was last saved automatically on ${n}.`,e.innerHTML=`<i class="fa-solid fa-check"></i> Autosaved ${n}`}e?.classList.toggle("d-none",!t),tt=setTimeout(it,y)}function st(e){const t=new Date(e);return ge((t.getUTCHours()+24*(t.getUTCDate()-1)).toString())+":"+ge(t.getUTCMinutes().toString())+":"+ge(t.getUTCSeconds().toString())}function rt(e){if(Me?.port?.isOpen){const t=performance.now(),n=document.getElementById("total-record-time"),o=Me.getTime();s[`${e}Time`]=o,document.getElementById("record-time").innerText=st(o);const i=new Date(o),r=document.getElementById("ser-time-progress-bar");if(r.classList.toggle("d-none",!h),h){const e=document.getElementById("ser-time-progress"),t=Math.round(i.getTime()/g*100);e.style.width=t+"%",e.innerText=t+"%",r.setAttribute("aria-valuenow",t.toString()),n.innerText=" / "+st(g)}else n.innerText="";if(K(),i.getTime()>=g&&h)Ge(!0),new a.ToastNotification("autoStop"),(0,a.launchSysNotification)("Recording Stopped!","Your desired recording time has expired and the recording has automatically stopped.");else{const n=performance.now()-t;nt=setTimeout(rt,p-n>0?p-n:1,e)}}}document.getElementById("autoscroll-console").onclick=e=>{return t=e.target.checked,ot=t,void Ue("consoleAutoscrollEnabled",ot);var t};let lt,ct=performance.now();function dt(e,t=!1){if(Me?.port?.isOpen){const n=performance.now(),a=Me.getData(),i=Me.getTime()??1e3;"hist"===o.SerialManager.orderType?s.addHist(e,a):"chron"===o.SerialManager.orderType&&s.addPulseData(e,a,o.SerialManager.adcChannels),s[`${e}Cps`]=s[e].map((e=>e/i*1e3)),t?(r.resetPlot(s,b),oe()):r.updatePlot(s,b);const l=i-ct;ct=i;const c=("chron"===o.SerialManager.orderType?a.length:a.reduce(((e,t)=>e+t),0))/l*1e3;b.push(c),document.getElementById("cps").innerText=c.toFixed(1)+" cps";const d=b.reduce(((e,t)=>e+t),0)/b.length,m=Math.sqrt(b.reduce(((e,t)=>e+(t-d)**2),0)/(b.length-1));document.getElementById("avg-cps").innerText="Avg: "+d.toFixed(1),document.getElementById("avg-cps-std").innerHTML=` &plusmn; ${m.toFixed(1)} cps (&#916; ${Math.round(m/d*100)}%)`,Z();const h=performance.now()-n;lt=setTimeout(dt,u-h>0?u-h:1,e)}}})()})();